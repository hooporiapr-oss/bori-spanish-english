<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>La Marquesina ‚Äî Hey Bori</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap');

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  :root {
    --bori-bg: #1a1128;
    --bori-surface: #251a38;
    --bori-gold: #FFD700;
    --bori-teal: #00D9A5;
    --bori-coral: #FF6B6B;
    --bori-purple: #9B59B6;
    --bori-blue: #5DADE2;
    --bori-text: #F0E6FF;
    --bori-muted: #8B7FA8;
    --tile-bg: #f5f0e8;
    --tile-border: #2a2a2a;
    --tile-dot: #1a1a1a;
    --tile-divider: #c8c0b4;
    --ui-border: #5a4a72;
    --tile-flash: #FFD700;
    --tile-selected: #00D9A5;
    --tile-wrong: #FF6B6B;
    --tile-correct: #00D9A5;
  }

  html, body {
    height: 100%;
    overflow: hidden;
    font-family: 'Fredoka', sans-serif;
    background: var(--bori-bg);
    color: var(--bori-text);
    touch-action: manipulation;
  }

  .game-container {
    display: flex;
    flex-direction: column;
    height: 100dvh;
    max-width: 430px;
    margin: 0 auto;
    padding: 8px 6px 6px;
    position: relative;
  }

  /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
  .top-bar {
    display: flex; align-items: center;
    justify-content: space-between;
    padding: 4px 4px 6px; flex-shrink: 0;
  }
  .top-bar .back-btn {
    font-size: 22px; color: var(--bori-gold);
    text-decoration: none; padding: 4px 8px; line-height: 1;
  }
  .top-bar .title {
    font-size: 15px; font-weight: 700; color: var(--bori-gold);
    text-transform: uppercase; letter-spacing: 1.5px;
    text-align: center; flex: 1;
  }
  .top-bar .help-btn {
    width: 30px; height: 30px; border-radius: 50%;
    border: 2px solid var(--bori-gold); background: transparent;
    color: var(--bori-gold); font-size: 16px; font-weight: 700;
    cursor: pointer; display: flex; align-items: center;
    justify-content: center; font-family: 'Fredoka', sans-serif;
  }

  /* ‚îÄ‚îÄ INFO STRIP ‚îÄ‚îÄ */
  .info-strip {
    display: flex; justify-content: space-between;
    padding: 6px 8px; background: var(--bori-surface);
    border-radius: 10px; margin-bottom: 6px; flex-shrink: 0;
  }
  .info-item { text-align: center; flex: 1; }
  .info-label { font-size: 9px; color: var(--bori-muted); text-transform: uppercase; letter-spacing: 1px; }
  .info-value { font-size: 16px; font-weight: 700; color: var(--bori-gold); }
  .info-value.teal { color: var(--bori-teal); }

  /* ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ */
  .status-bar {
    text-align: center; padding: 4px; font-size: 13px;
    font-weight: 600; color: var(--bori-muted);
    flex-shrink: 0; min-height: 24px;
  }
  .status-bar.watching { color: var(--bori-gold); }
  .status-bar.your-turn { color: var(--bori-teal); }
  .status-bar.correct { color: var(--bori-teal); }
  .status-bar.wrong { color: var(--bori-coral); }

  /* ‚îÄ‚îÄ BOARD ‚îÄ‚îÄ */
  .board-area {
    flex: 1; display: flex; align-items: center;
    justify-content: center; overflow: hidden; min-height: 0;
  }
  .domino-board {
    display: grid; grid-template-columns: repeat(7, 1fr);
    gap: 4px; width: 100%; max-width: 400px; padding: 4px;
  }

  /* ‚îÄ‚îÄ TILE ‚îÄ‚îÄ */
  .domino-tile {
    aspect-ratio: 1 / 1.55; background: var(--tile-bg);
    border: 2px solid var(--tile-border); border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.8);
    display: flex; flex-direction: column; align-items: center;
    justify-content: space-around; cursor: pointer;
    transition: none;
    position: relative; padding: 3px 2px; user-select: none;
    will-change: transform;
  }
  .domino-tile::after {
    content: ''; position: absolute; top: 48%; left: 12%; right: 12%;
    height: 2px; background: var(--tile-divider); border-radius: 1px;
  }
  .domino-tile.disabled { pointer-events: none; }
  .domino-tile.flashing {
    border-color: var(--bori-gold);
    background: #FFF8DC;
    transform: scale(1.12);
    outline: 3px solid var(--bori-gold);
    outline-offset: -1px;
    box-shadow: 0 0 24px rgba(255,215,0,0.7), 0 0 48px rgba(255,215,0,0.3);
    animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 2;
  }
  .domino-tile.flashing::after { background: rgba(255,215,0,0.4); }
  .domino-tile.flash-orange {
    border-color: #FF8C00;
    background: #FFF0E0;
    transform: scale(1.12);
    outline: 3px solid #FF8C00;
    outline-offset: -1px;
    box-shadow: 0 0 24px rgba(255,140,0,0.7), 0 0 48px rgba(255,140,0,0.3);
    animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 2;
  }
  .domino-tile.flash-orange::after { background: rgba(255,140,0,0.3); }
  .domino-tile.selected {
    border-color: var(--tile-selected); background: #E0FFF5;
    outline: 2px solid var(--tile-selected); outline-offset: -1px;
    box-shadow: 0 0 12px rgba(0,217,165,0.4);
  }
  .domino-tile.selected::after { background: rgba(0,217,165,0.3); }
  .domino-tile.correct-tile {
    border-color: var(--tile-correct); background: #D4FFED;
    box-shadow: 0 0 12px rgba(0,217,165,0.4);
  }
  .domino-tile.correct-tile::after { background: rgba(0,217,165,0.3); }
  .domino-tile.wrong-tile {
    border-color: var(--tile-wrong); background: #FFE0E0;
    animation: shake 0.4s ease;
    box-shadow: 0 0 12px rgba(255,107,107,0.4);
  }
  .domino-tile.wrong-tile::after { background: rgba(255,107,107,0.3); }
  .domino-tile:active:not(.disabled) { transform: scale(0.95); }

  /* ‚îÄ‚îÄ DOTS ‚îÄ‚îÄ */
  .dot-half {
    display: flex; flex-wrap: wrap; align-items: center;
    justify-content: center; width: 80%; height: 42%; position: relative;
  }
  .dot {
    width: 7px; height: 7px; background: var(--tile-dot);
    border-radius: 50%; position: absolute;
  }
  .domino-tile.flashing .dot { background: #1a1128; }
  .domino-tile.flash-orange .dot { background: #1a1128; }
  .domino-tile.selected .dot { background: #1a1128; }

  /* ‚îÄ‚îÄ BOTTOM ‚îÄ‚îÄ */
  .bottom-controls {
    flex-shrink: 0; padding: 6px 4px 4px;
    display: flex; flex-direction: column; gap: 6px;
  }
  .sequence-dots {
    display: flex; justify-content: center; gap: 5px;
    min-height: 14px; flex-wrap: wrap;
  }
  .seq-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--ui-border); transition: background 0.2s;
  }
  .seq-dot.filled { background: var(--bori-teal); }
  .seq-dot.current { background: var(--bori-gold); box-shadow: 0 0 6px var(--bori-gold); }
  .btn-row { display: flex; gap: 8px; justify-content: center; }
  .game-btn {
    padding: 10px 24px; border: none; border-radius: 25px;
    font-family: 'Fredoka', sans-serif; font-size: 14px;
    font-weight: 600; cursor: pointer; transition: transform 0.1s;
  }
  .game-btn:active { transform: scale(0.95); }
  .btn-primary { background: linear-gradient(135deg, var(--bori-gold), #FFA500); color: #1a1128; }
  .btn-secondary { background: var(--bori-surface); color: var(--bori-text); border: 2px solid var(--ui-border); }

  /* ‚îÄ‚îÄ WELCOME ‚îÄ‚îÄ */
  .welcome-screen {
    position: absolute; inset: 0; background: var(--bori-bg);
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; z-index: 50; padding: 20px;
    text-align: center; overflow-y: auto;
  }
  .welcome-screen.hidden { display: none; }
  .welcome-icon { font-size: 44px; margin-bottom: 6px; margin-top: 48px; }
  .welcome-title { font-size: 26px; font-weight: 700; color: var(--bori-gold); margin-bottom: 2px; }
  .welcome-subtitle { font-size: 13px; font-weight: 600; color: var(--bori-text); margin-bottom: 2px; letter-spacing: 0.5px; }
  .welcome-sub { font-size: 11px; color: var(--bori-muted); margin-bottom: 12px; }

  /* ‚îÄ‚îÄ MODE SELECTOR ‚îÄ‚îÄ */
  .mode-selector {
    display: flex; gap: 6px; width: 100%; max-width: 320px; margin-bottom: 12px;
  }
  .mode-btn {
    flex: 1; padding: 10px 4px; border-radius: 12px;
    border: 2.5px solid var(--ui-border); background: var(--bori-surface);
    color: var(--bori-text); font-family: 'Fredoka', sans-serif;
    font-size: 11px; font-weight: 700; text-align: center;
    cursor: pointer; transition: border-color 0.2s, background 0.2s;
  }
  .mode-btn .mode-icon { font-size: 20px; display: block; margin-bottom: 2px; }
  .mode-btn .mode-name { display: block; text-transform: uppercase; letter-spacing: 0.5px; }
  .mode-btn .mode-desc {
    display: block; font-size: 8px; font-weight: 500;
    color: var(--bori-muted); margin-top: 1px;
  }
  .mode-btn.active {
    border-color: var(--bori-gold); background: rgba(255,215,0,0.1); color: var(--bori-gold);
  }
  .mode-btn.active .mode-desc { color: var(--bori-gold); opacity: 0.7; }

  /* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
  .setting-group { width: 100%; max-width: 300px; margin-bottom: 10px; }
  .setting-label {
    font-size: 11px; color: var(--bori-muted);
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;
  }
  .setting-options { display: flex; gap: 6px; }
  .setting-opt {
    flex: 1; padding: 8px 6px; border-radius: 12px;
    border: 2px solid var(--ui-border); background: var(--bori-surface);
    color: var(--bori-text); font-family: 'Fredoka', sans-serif;
    font-size: 12px; font-weight: 600; text-align: center;
    cursor: pointer; transition: border-color 0.2s, background 0.2s;
  }
  .setting-opt.active {
    border-color: var(--bori-gold); background: rgba(255,215,0,0.1); color: var(--bori-gold);
  }
  .setting-opt .opt-icon { font-size: 16px; display: block; margin-bottom: 2px; }

  .start-btn {
    margin-top: 6px; padding: 14px 48px; border-radius: 30px; border: none;
    background: linear-gradient(135deg, var(--bori-gold), #FFA500);
    color: #1a1128; font-family: 'Fredoka', sans-serif;
    font-size: 18px; font-weight: 700; cursor: pointer;
    text-transform: uppercase; letter-spacing: 1px;
  }
  .start-btn:active { transform: scale(0.95); }

  /* ‚îÄ‚îÄ WELCOME TOP BAR ‚îÄ‚îÄ */
  .welcome-top-bar {
    position: absolute; top: 12px; left: 12px; right: 12px;
    display: flex; justify-content: space-between; align-items: center; z-index: 10;
  }
  .welcome-back-btn {
    background: none; border: none; color: var(--bori-gold);
    font-family: 'Fredoka', sans-serif; font-size: 16px; font-weight: 600;
    text-decoration: none; padding: 6px 10px;
    display: flex; align-items: center; gap: 4px;
  }
  .welcome-top-right { display: flex; align-items: center; gap: 8px; }
  .welcome-lang-toggle {
    display: flex; gap: 3px; background: rgba(255,255,255,0.06);
    border-radius: 20px; padding: 3px;
  }
  .wlang-btn {
    padding: 4px 12px; border-radius: 16px; border: none;
    font-family: 'Fredoka', sans-serif; font-size: 12px; font-weight: 600;
    cursor: pointer; background: transparent; color: var(--bori-muted);
    transition: all 0.2s;
  }
  .wlang-btn.active { background: var(--bori-gold); color: #1a1128; }
  .welcome-help-btn {
    width: 32px; height: 32px; border-radius: 50%;
    background: rgba(255,215,0,0.12); border: 1.5px solid var(--bori-gold);
    color: var(--bori-gold); font-family: 'Fredoka', sans-serif;
    font-size: 15px; font-weight: 700; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }

  /* ‚îÄ‚îÄ SETTINGS VISIBILITY ‚îÄ‚îÄ */
  .mode-settings { display: none; }
  .mode-settings.visible { display: block; }

  /* ‚îÄ‚îÄ HELP MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position: absolute; inset: 0; background: rgba(10,6,20,0.92);
    z-index: 100; display: flex; align-items: center;
    justify-content: center; padding: 16px;
  }
  .modal-overlay.hidden { display: none; }
  .modal-box {
    background: var(--bori-surface); border: 2px solid var(--ui-border);
    border-radius: 16px; padding: 20px; max-width: 360px;
    width: 100%; max-height: 80vh; overflow-y: auto;
  }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
  .modal-title { font-size: 18px; font-weight: 700; color: var(--bori-gold); }
  .modal-close {
    width: 28px; height: 28px; border-radius: 50%;
    border: 2px solid var(--bori-muted); background: transparent;
    color: var(--bori-muted); font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }
  .lang-toggle { display: flex; gap: 4px; margin-bottom: 14px; }
  .lang-btn {
    padding: 5px 14px; border-radius: 20px; border: 2px solid var(--ui-border);
    background: transparent; color: var(--bori-muted);
    font-family: 'Fredoka', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer;
  }
  .lang-btn.active {
    border-color: var(--bori-teal); color: var(--bori-teal); background: rgba(0,217,165,0.1);
  }
  .rules-content h3 { font-size: 14px; font-weight: 600; color: var(--bori-teal); margin: 10px 0 4px; }
  .rules-content p { font-size: 12px; color: var(--bori-text); line-height: 1.5; margin-bottom: 6px; }
  .rules-content.hidden { display: none; }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    50% { transform: translateX(6px); }
    75% { transform: translateX(-4px); }
  }
  @keyframes popIn {
    0% { transform: scale(1); }
    50% { transform: scale(1.18); }
    100% { transform: scale(1.12); }
  }

  /* ‚îÄ‚îÄ TIMER BAR ‚îÄ‚îÄ */
  .timer-bar-container {
    height: 4px; background: var(--ui-border); border-radius: 2px;
    overflow: hidden; flex-shrink: 0;
  }
  .timer-bar-container.hidden { visibility: hidden; }
  .timer-bar {
    height: 100%; background: var(--bori-teal); border-radius: 2px;
    transition: width 0.1s linear; width: 100%;
  }
  .timer-bar.warning { background: var(--bori-coral); }

  /* ‚îÄ‚îÄ SMALL PHONES ‚îÄ‚îÄ */
  @media (max-height: 650px) {
    .domino-tile { border-radius: 6px; }
    .dot { width: 5px; height: 5px; }
    .info-strip { padding: 4px 6px; margin-bottom: 4px; }
    .info-value { font-size: 14px; }
    .game-btn { padding: 8px 20px; font-size: 13px; }
    .status-bar { font-size: 11px; min-height: 20px; padding: 2px; }
    .bottom-controls { padding: 4px; gap: 4px; }
    .welcome-icon { font-size: 36px; margin-top: 44px; margin-bottom: 4px; }
    .welcome-title { font-size: 22px; }
    .mode-btn { padding: 6px 3px; font-size: 10px; }
    .mode-btn .mode-icon { font-size: 16px; }
    .setting-opt { padding: 6px 4px; font-size: 11px; }
    .start-btn { padding: 12px 40px; font-size: 16px; }
    .welcome-sub { margin-bottom: 8px; }
    .setting-group { margin-bottom: 8px; }
  }
</style>
</head>
<body>

<div class="game-container">
  <!-- TOP BAR -->
  <div class="top-bar">
    <a href="#" class="back-btn" onclick="event.preventDefault(); backToWelcome();">‚Üê</a>
    <div class="title">La Marquesina</div>
    <button class="help-btn" onclick="toggleHelp()">?</button>
  </div>

  <!-- INFO STRIP -->
  <div class="info-strip">
    <div class="info-item">
      <div class="info-label" id="lblCount">Secuencia</div>
      <div class="info-value" id="seqDisplay">3</div>
    </div>
    <div class="info-item">
      <div class="info-label" data-i18n="label-streak">Racha</div>
      <div class="info-value teal" id="streakDisplay">0/2</div>
    </div>
    <div class="info-item">
      <div class="info-label" data-i18n="label-best">R√©cord</div>
      <div class="info-value" id="bestDisplay">3</div>
    </div>
    <div class="info-item">
      <div class="info-label" data-i18n="label-score">Puntos</div>
      <div class="info-value teal" id="scoreDisplay">0</div>
    </div>
  </div>

  <!-- STATUS -->
  <div class="status-bar" id="statusBar">¬°Prep√°rate!</div>

  <!-- TIMER BAR -->
  <div class="timer-bar-container hidden" id="timerBarContainer">
    <div class="timer-bar" id="timerBar"></div>
  </div>

  <!-- BOARD -->
  <div class="board-area">
    <div class="domino-board" id="dominoBoard"></div>
  </div>

  <!-- BOTTOM -->
  <div class="bottom-controls">
    <div class="sequence-dots" id="sequenceDots"></div>
    <div class="btn-row">
      <button class="game-btn btn-secondary" onclick="resetGame()" data-i18n="btn-reset">Reiniciar</button>
      <button class="game-btn btn-primary" id="actionBtn" onclick="startRound()">Empezar</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê WELCOME SCREEN ‚ïê‚ïê‚ïê -->
  <div class="welcome-screen" id="welcomeScreen">
    <div class="welcome-top-bar">
      <a href="/" class="welcome-back-btn">‚Üê Bori</a>
      <div class="welcome-top-right">
        <div class="welcome-lang-toggle">
          <button class="wlang-btn active" onclick="setLangWelcome('es')">ES</button>
          <button class="wlang-btn" onclick="setLangWelcome('en')">EN</button>
        </div>
        <button class="welcome-help-btn" onclick="toggleHelp()">?</button>
      </div>
    </div>
    <div class="welcome-icon">üÅ£</div>
    <div class="welcome-title">La Marquesina</div>
    <div class="welcome-subtitle" data-i18n="welcome-game">Dominoes Cognitivo</div>
    <div class="welcome-sub" data-i18n="welcome-sub">Memoria ¬∑ Secuencia ¬∑ Domin√≥</div>

    <!-- MODE SELECTOR -->
    <div class="mode-selector">
      <div class="mode-btn active" data-mode="secuencia" onclick="selectMode('secuencia')">
        <span class="mode-icon">üî¢</span>
        <span class="mode-name">Secuencia</span>
        <span class="mode-desc" data-i18n="mode-sec-desc">Orden importa</span>
      </div>
      <div class="mode-btn" data-mode="relampago" onclick="selectMode('relampago')">
        <span class="mode-icon">‚ö°</span>
        <span class="mode-name">Rel√°mpago</span>
        <span class="mode-desc" data-i18n="mode-rel-desc">Recuerda cu√°les</span>
      </div>
      <div class="mode-btn" data-mode="trampa" onclick="selectMode('trampa')">
        <span class="mode-icon">üé≠</span>
        <span class="mode-name">Trampa</span>
        <span class="mode-desc" data-i18n="mode-tra-desc">Detecta el cambio</span>
      </div>
    </div>

    <!-- SECUENCIA SETTINGS -->
    <div class="mode-settings visible" id="secuenciaSettings">
      <div class="setting-group">
        <div class="setting-label" data-i18n="setting-flash">Velocidad del Flash</div>
        <div class="setting-options" id="speedOptions">
          <div class="setting-opt" data-speed="slow" onclick="setSpeed('slow')">
            <span class="opt-icon">üê¢</span><span data-i18n="speed-slow">Lento</span>
          </div>
          <div class="setting-opt active" data-speed="medium" onclick="setSpeed('medium')">
            <span class="opt-icon">üèÉ</span><span data-i18n="speed-medium">Medio</span>
          </div>
          <div class="setting-opt" data-speed="fast" onclick="setSpeed('fast')">
            <span class="opt-icon">‚ö°</span><span data-i18n="speed-fast">R√°pido</span>
          </div>
        </div>
      </div>
      <div class="setting-group">
        <div class="setting-label" data-i18n="setting-response">Tiempo de Respuesta</div>
        <div class="setting-options" id="responseOptions">
          <div class="setting-opt" data-response="relaxed" onclick="setResponse('relaxed')">
            <span class="opt-icon">üòå</span><span data-i18n="resp-relaxed">Relajado</span>
          </div>
          <div class="setting-opt active" data-response="normal" onclick="setResponse('normal')">
            <span class="opt-icon">üòé</span><span data-i18n="resp-normal">Normal</span>
          </div>
          <div class="setting-opt" data-response="pressure" onclick="setResponse('pressure')">
            <span class="opt-icon">üî•</span><span data-i18n="resp-pressure">Presi√≥n</span>
          </div>
        </div>
      </div>
    </div>

    <!-- REL√ÅMPAGO SETTINGS -->
    <div class="mode-settings" id="relampagoSettings">
      <div class="setting-group">
        <div class="setting-label" data-i18n="setting-level">Nivel de Dificultad</div>
        <div class="setting-options" id="levelOptions">
          <div class="setting-opt active" data-level="1" onclick="setLevel(1)">
            <span class="opt-icon">üëÅÔ∏è</span><span data-i18n="level-1">Nivel 1</span>
          </div>
          <div class="setting-opt" data-level="2" onclick="setLevel(2)">
            <span class="opt-icon">üëÄ</span><span data-i18n="level-2">Nivel 2</span>
          </div>
          <div class="setting-opt" data-level="3" onclick="setLevel(3)">
            <span class="opt-icon">‚ö°</span><span data-i18n="level-3">Nivel 3</span>
          </div>
        </div>
      </div>
    </div>

    <!-- TRAMPA SETTINGS -->
    <div class="mode-settings" id="trampaSettings">
      <div class="setting-group">
        <div class="setting-label" data-i18n="setting-flash">Velocidad del Flash</div>
        <div class="setting-options" id="trampaSpeedOptions">
          <div class="setting-opt" data-tspeed="slow" onclick="setTrampaSpeed('slow')">
            <span class="opt-icon">üê¢</span><span data-i18n="speed-slow">Lento</span>
          </div>
          <div class="setting-opt active" data-tspeed="medium" onclick="setTrampaSpeed('medium')">
            <span class="opt-icon">üèÉ</span><span data-i18n="speed-medium">Medio</span>
          </div>
          <div class="setting-opt" data-tspeed="fast" onclick="setTrampaSpeed('fast')">
            <span class="opt-icon">‚ö°</span><span data-i18n="speed-fast">R√°pido</span>
          </div>
        </div>
      </div>
    </div>

    <button class="start-btn" onclick="closeWelcome()" data-i18n="btn-play">JUGAR</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê HELP MODAL ‚ïê‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="helpModal">
    <div class="modal-box">
      <div class="modal-header">
        <div class="modal-title" data-i18n="help-title">C√≥mo Jugar</div>
        <button class="modal-close" onclick="toggleHelp()">‚úï</button>
      </div>
      <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('es')">ES</button>
        <button class="lang-btn" onclick="setLang('en')">EN</button>
      </div>

      <!-- SECUENCIA ES -->
      <div class="rules-content" id="rulesSecES">
        <h3>üî¢ Secuencia</h3>
        <h3>üéØ Objetivo</h3>
        <p>Observa la secuencia de fichas de domin√≥ que se iluminan y rep√≠tela toc√°ndolas en el mismo orden.</p>
        <h3>üìà Progresi√≥n</h3>
        <p>Comienzas con 3 fichas. Aciertas 2 veces seguidas y la secuencia crece a 4, luego 5, y as√≠ hasta las 28 fichas.</p>
        <h3>üìâ Si fallas</h3>
        <p>Bajas un nivel. Nunca menos de 3. Sin castigo extremo ‚Äî siempre puedes escalar de vuelta.</p>
        <h3>‚ö° Velocidad del Flash</h3>
        <p>Lento, Medio, o R√°pido ‚Äî controla qu√© tan r√°pido se iluminan las fichas.</p>
        <h3>‚è±Ô∏è Tiempo de Respuesta</h3>
        <p>Relajado (sin l√≠mite), Normal (5s por ficha), o Presi√≥n (2.5s por ficha).</p>
        <h3>‚≠ê Puntos</h3>
        <p>M√°s secuencia + m√°s velocidad = m√°s puntos.</p>
      </div>
      <!-- SECUENCIA EN -->
      <div class="rules-content hidden" id="rulesSecEN">
        <h3>üî¢ Secuencia</h3>
        <h3>üéØ Goal</h3>
        <p>Watch the domino tiles that light up and tap them back in the same order.</p>
        <h3>üìà Progression</h3>
        <p>Start with 3 tiles. Get it right 2 times in a row and the sequence grows to 4, then 5, up to 28.</p>
        <h3>üìâ If You Fail</h3>
        <p>Drop one level. Never below 3. No harsh penalties ‚Äî climb back up.</p>
        <h3>‚ö° Flash Speed</h3>
        <p>Slow, Medium, or Fast ‚Äî how quickly tiles light up.</p>
        <h3>‚è±Ô∏è Response Time</h3>
        <p>Relaxed (no limit), Normal (5s per tile), or Pressure (2.5s per tile).</p>
        <h3>‚≠ê Points</h3>
        <p>Longer sequences + faster speed = more points.</p>
      </div>

      <!-- REL√ÅMPAGO ES -->
      <div class="rules-content hidden" id="rulesRelES">
        <h3>‚ö° Rel√°mpago</h3>
        <h3>üéØ Objetivo</h3>
        <p>Varias fichas se iluminan al mismo tiempo. Recuerda cu√°les eran y t√≥calas ‚Äî el orden no importa.</p>
        <h3>üìà Progresi√≥n</h3>
        <p>Comienzas con 3 fichas. Aciertas 2 veces seguidas y sube a 4, luego 5, hasta un m√°ximo de 10.</p>
        <h3>üìâ Si fallas</h3>
        <p>Bajas un nivel. Nunca menos de 3. Siempre puedes escalar de vuelta.</p>
        <h3>üëÅÔ∏è Niveles de Dificultad</h3>
        <p>Nivel 1 ‚Äî las fichas se muestran por m√°s tiempo. Nivel 2 ‚Äî menos tiempo. Nivel 3 ‚Äî un destello r√°pido.</p>
        <h3>‚≠ê Puntos</h3>
        <p>M√°s fichas + nivel m√°s alto = m√°s puntos.</p>
      </div>
      <!-- REL√ÅMPAGO EN -->
      <div class="rules-content hidden" id="rulesRelEN">
        <h3>‚ö° Rel√°mpago</h3>
        <h3>üéØ Goal</h3>
        <p>Several tiles flash at the same time. Remember which ones they were and tap them ‚Äî order doesn't matter.</p>
        <h3>üìà Progression</h3>
        <p>Start with 3 tiles. Get it right 2 times in a row and it grows to 4, then 5, up to a max of 10.</p>
        <h3>üìâ If You Fail</h3>
        <p>Drop one level. Never below 3. You can always climb back up.</p>
        <h3>üëÅÔ∏è Difficulty Levels</h3>
        <p>Level 1 ‚Äî tiles show longer. Level 2 ‚Äî less time. Level 3 ‚Äî a quick flash.</p>
        <h3>‚≠ê Points</h3>
        <p>More tiles + higher level = more points.</p>
      </div>

      <!-- TRAMPA ES -->
      <div class="rules-content hidden" id="rulesTraES">
        <h3>üé≠ Trampa</h3>
        <h3>üéØ Objetivo</h3>
        <p>Observa una secuencia de fichas. Luego se repite ‚Äî pero una ficha cambi√≥. Toca la ficha impostora.</p>
        <h3>üìà Progresi√≥n</h3>
        <p>Comienzas con 4 fichas. Aciertas 2 veces seguidas y la secuencia crece a 5, luego 6, hasta las 28 fichas.</p>
        <h3>üìâ Si fallas</h3>
        <p>Bajas un nivel. Nunca menos de 4. Siempre puedes escalar de vuelta.</p>
        <h3>‚ö° Velocidad del Flash</h3>
        <p>Lento, Medio, o R√°pido ‚Äî controla la velocidad de ambas pasadas.</p>
        <h3>üé≠ C√≥mo funciona</h3>
        <p>Primera pasada: la secuencia original (dorado). Segunda pasada: la misma secuencia pero con una trampa (naranja). Encuentra la ficha que no estaba antes.</p>
        <h3>‚≠ê Puntos</h3>
        <p>M√°s fichas + m√°s velocidad = m√°s puntos.</p>
      </div>
      <!-- TRAMPA EN -->
      <div class="rules-content hidden" id="rulesTraEN">
        <h3>üé≠ Trampa</h3>
        <h3>üéØ Goal</h3>
        <p>Watch a sequence of tiles. Then it replays ‚Äî but one tile changed. Tap the impostor tile.</p>
        <h3>üìà Progression</h3>
        <p>Start with 4 tiles. Get it right 2 times in a row and the sequence grows to 5, then 6, up to 28.</p>
        <h3>üìâ If You Fail</h3>
        <p>Drop one level. Never below 4. You can always climb back up.</p>
        <h3>‚ö° Flash Speed</h3>
        <p>Slow, Medium, or Fast ‚Äî controls the speed of both passes.</p>
        <h3>üé≠ How It Works</h3>
        <p>First pass: the original sequence (gold). Second pass: the same sequence but with a trap (orange). Find the tile that wasn't there before.</p>
        <h3>‚≠ê Points</h3>
        <p>More tiles + faster speed = more points.</p>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê FULL DOMINO SET (28 tiles) ‚ïê‚ïê‚ïê
const FULL_SET = [];
for (let a = 0; a <= 6; a++) {
  for (let b = a; b <= 6; b++) FULL_SET.push([a, b]);
}

// ‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê
const SPEEDS = { slow: 900, medium: 550, fast: 300 };
const GAPS = { slow: 400, medium: 250, fast: 150 };
const RESPONSE_TIMES = { relaxed: Infinity, normal: 5000, pressure: 2500 };
const RELAMPAGO_FLASH = { 1: 2000, 2: 1000, 3: 450 };
const RELAMPAGO_RESPONSE = 15000;
const TRAMPA_RESPONSE = 10000;

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let gameMode = 'secuencia';
let speed = 'medium';
let responseLevel = 'normal';
let relampagoLevel = 1;
let trampaSpeed = 'medium';
let sequenceLength = 3;
let currentSequence = [];
let trampaOriginal = [];
let trampaModified = [];
let trampaImpostor = -1;
let playerInput = [];
let consecutiveWins = 0;
let bestSequence = 3;
let score = 0;
let isFlashing = false;
let isPlayerTurn = false;
let responseTimer = null;
let timerInterval = null;
let timerStart = 0;
let lang = 'es';

// ‚ïê‚ïê‚ïê i18n ‚ïê‚ïê‚ïê
const STRINGS = {
  es: {
    'label-seq': 'Secuencia', 'label-tiles': 'Fichas', 'label-trampa': 'Fichas',
    'label-streak': 'Racha', 'label-best': 'R√©cord', 'label-score': 'Puntos',
    'status-ready': '¬°Prep√°rate!',
    'status-watching': 'üëÄ ¬°Observa la secuencia!',
    'status-watching-rel': 'üëÄ ¬°Observa las fichas!',
    'status-watching-tra': 'üëÄ ¬°Observa ‚Äî primera pasada!',
    'status-watching-tra2': 'üé≠ ¬°Segunda pasada ‚Äî encuentra la trampa!',
    'status-your-turn': 'üéØ ¬°Tu turno!',
    'status-your-turn-rel': 'üéØ ¬°Toca las fichas!',
    'status-your-turn-tra': 'üé≠ ¬°Toca la impostora!',
    'status-correct': '‚úÖ ¬°Correcto!',
    'status-wrong': '‚ùå ¬°Fallaste!',
    'status-levelup': 'üî• ¬°Nivel arriba!',
    'status-timeout': '‚è±Ô∏è ¬°Tiempo!',
    'btn-reset': 'Reiniciar', 'btn-start': 'Empezar', 'btn-next': 'Siguiente',
    'welcome-sub': 'Memoria ¬∑ Secuencia ¬∑ Domin√≥',
    'welcome-game': 'Dominoes Cognitivo',
    'setting-flash': 'Velocidad del Flash', 'setting-response': 'Tiempo de Respuesta',
    'setting-level': 'Nivel de Dificultad',
    'speed-slow': 'Lento', 'speed-medium': 'Medio', 'speed-fast': 'R√°pido',
    'resp-relaxed': 'Relajado', 'resp-normal': 'Normal', 'resp-pressure': 'Presi√≥n',
    'level-1': 'Nivel 1', 'level-2': 'Nivel 2', 'level-3': 'Nivel 3',
    'btn-play': 'JUGAR', 'help-title': 'C√≥mo Jugar',
    'mode-sec-desc': 'Orden importa', 'mode-rel-desc': 'Recuerda cu√°les',
    'mode-tra-desc': 'Detecta el cambio',
  },
  en: {
    'label-seq': 'Sequence', 'label-tiles': 'Tiles', 'label-trampa': 'Tiles',
    'label-streak': 'Streak', 'label-best': 'Best', 'label-score': 'Score',
    'status-ready': 'Get ready!',
    'status-watching': 'üëÄ Watch the sequence!',
    'status-watching-rel': 'üëÄ Watch the tiles!',
    'status-watching-tra': 'üëÄ Watch ‚Äî first pass!',
    'status-watching-tra2': 'üé≠ Second pass ‚Äî find the trap!',
    'status-your-turn': 'üéØ Your turn!',
    'status-your-turn-rel': 'üéØ Tap the tiles!',
    'status-your-turn-tra': 'üé≠ Tap the impostor!',
    'status-correct': '‚úÖ Correct!',
    'status-wrong': '‚ùå Wrong!',
    'status-levelup': 'üî• Level up!',
    'status-timeout': '‚è±Ô∏è Time\'s up!',
    'btn-reset': 'Reset', 'btn-start': 'Start', 'btn-next': 'Next',
    'welcome-sub': 'Memory ¬∑ Sequence ¬∑ Dominoes',
    'welcome-game': 'Cognitive Dominoes',
    'setting-flash': 'Flash Speed', 'setting-response': 'Response Time',
    'setting-level': 'Difficulty Level',
    'speed-slow': 'Slow', 'speed-medium': 'Medium', 'speed-fast': 'Fast',
    'resp-relaxed': 'Relaxed', 'resp-normal': 'Normal', 'resp-pressure': 'Pressure',
    'level-1': 'Level 1', 'level-2': 'Level 2', 'level-3': 'Level 3',
    'btn-play': 'PLAY', 'help-title': 'How to Play',
    'mode-sec-desc': 'Order matters', 'mode-rel-desc': 'Remember which',
    'mode-tra-desc': 'Spot the change',
  }
};

function t(key) { return STRINGS[lang][key] || key; }
function applyLang() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t(el.getAttribute('data-i18n'));
  });
}

function setLang(l) {
  lang = l;
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  const helpBtn = document.querySelector(`.lang-btn[onclick="setLang('${l}')"]`);
  if (helpBtn) helpBtn.classList.add('active');
  document.querySelectorAll('.wlang-btn').forEach(b => b.classList.remove('active'));
  const welcomeBtn = document.querySelector(`.wlang-btn[onclick="setLangWelcome('${l}')"]`);
  if (welcomeBtn) welcomeBtn.classList.add('active');
  syncHelpContent();
  applyLang();
  updateUI();
}

function setLangWelcome(l) { setLang(l); }

function syncHelpContent() {
  const ids = ['rulesSecES','rulesSecEN','rulesRelES','rulesRelEN','rulesTraES','rulesTraEN'];
  ids.forEach(id => document.getElementById(id).classList.add('hidden'));
  if (gameMode === 'secuencia') {
    document.getElementById(lang === 'es' ? 'rulesSecES' : 'rulesSecEN').classList.remove('hidden');
  } else if (gameMode === 'relampago') {
    document.getElementById(lang === 'es' ? 'rulesRelES' : 'rulesRelEN').classList.remove('hidden');
  } else {
    document.getElementById(lang === 'es' ? 'rulesTraES' : 'rulesTraEN').classList.remove('hidden');
  }
}

// ‚ïê‚ïê‚ïê MODE SELECTOR ‚ïê‚ïê‚ïê
function selectMode(mode) {
  gameMode = mode;
  document.querySelectorAll('.mode-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.mode === mode));
  document.getElementById('secuenciaSettings').classList.toggle('visible', mode === 'secuencia');
  document.getElementById('relampagoSettings').classList.toggle('visible', mode === 'relampago');
  document.getElementById('trampaSettings').classList.toggle('visible', mode === 'trampa');
  syncHelpContent();
}

// ‚ïê‚ïê‚ïê DOT POSITIONS ‚ïê‚ïê‚ïê
const DOT_POSITIONS = {
  0: [], 1: [[50,50]], 2: [[25,25],[75,75]],
  3: [[25,25],[50,50],[75,75]], 4: [[25,25],[75,25],[25,75],[75,75]],
  5: [[25,25],[75,25],[50,50],[25,75],[75,75]],
  6: [[25,20],[75,20],[25,50],[75,50],[25,80],[75,80]],
};

function dotsHTML(n) {
  return DOT_POSITIONS[n].map(([x,y]) =>
    `<div class="dot" style="left:${x}%;top:${y}%;transform:translate(-50%,-50%)"></div>`
  ).join('');
}

// ‚ïê‚ïê‚ïê BUILD BOARD ‚ïê‚ïê‚ïê
function buildBoard() {
  const board = document.getElementById('dominoBoard');
  board.innerHTML = '';
  FULL_SET.forEach((tile, idx) => {
    const el = document.createElement('div');
    el.className = 'domino-tile';
    el.dataset.index = idx;
    el.innerHTML = `
      <div class="dot-half">${dotsHTML(tile[0])}</div>
      <div class="dot-half">${dotsHTML(tile[1])}</div>
    `;
    el.addEventListener('click', () => handleTap(idx));
    board.appendChild(el);
  });
}

// ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê
function setSpeed(s) {
  speed = s;
  document.querySelectorAll('#speedOptions .setting-opt').forEach(el =>
    el.classList.toggle('active', el.dataset.speed === s));
}
function setResponse(r) {
  responseLevel = r;
  document.querySelectorAll('#responseOptions .setting-opt').forEach(el =>
    el.classList.toggle('active', el.dataset.response === r));
}
function setLevel(l) {
  relampagoLevel = l;
  document.querySelectorAll('#levelOptions .setting-opt').forEach(el =>
    el.classList.toggle('active', parseInt(el.dataset.level) === l));
}
function setTrampaSpeed(s) {
  trampaSpeed = s;
  document.querySelectorAll('#trampaSpeedOptions .setting-opt').forEach(el =>
    el.classList.toggle('active', el.dataset.tspeed === s));
}

function closeWelcome() {
  document.getElementById('welcomeScreen').classList.add('hidden');
  // Set starting length based on mode
  if (gameMode === 'trampa') {
    sequenceLength = 4;
    bestSequence = 4;
  } else {
    sequenceLength = 3;
    bestSequence = 3;
  }
  updateUI();
  startRound();
}

// ‚ïê‚ïê‚ïê GAME LOGIC ‚ïê‚ïê‚ïê
function generateSequence(len) {
  const available = [...Array(28).keys()];
  const indices = [];
  for (let i = 0; i < len; i++) {
    const pick = Math.floor(Math.random() * available.length);
    indices.push(available.splice(pick, 1)[0]);
  }
  return indices;
}

function getCountLabel() {
  if (gameMode === 'secuencia') return t('label-seq');
  return t('label-tiles');
}

function updateUI() {
  document.getElementById('seqDisplay').textContent = sequenceLength;
  document.getElementById('streakDisplay').textContent = `${consecutiveWins}/2`;
  document.getElementById('bestDisplay').textContent = bestSequence;
  document.getElementById('scoreDisplay').textContent = score;
  document.getElementById('lblCount').textContent = getCountLabel();
  updateSequenceDots();
}

function updateSequenceDots() {
  const c = document.getElementById('sequenceDots');
  c.innerHTML = '';
  if (gameMode === 'trampa') return; // No dots for trampa
  for (let i = 0; i < sequenceLength; i++) {
    const d = document.createElement('div');
    d.className = 'seq-dot';
    if (i < playerInput.length) d.classList.add('filled');
    if (gameMode === 'secuencia' && i === playerInput.length && isPlayerTurn) d.classList.add('current');
    c.appendChild(d);
  }
}

function setStatus(key, extra = '') {
  const bar = document.getElementById('statusBar');
  bar.textContent = t(key) + extra;
  bar.className = 'status-bar';
  if (key.includes('watching')) bar.classList.add('watching');
  else if (key.includes('your-turn')) bar.classList.add('your-turn');
  else if (key.includes('correct') || key.includes('levelup')) bar.classList.add('correct');
  else if (key.includes('wrong') || key.includes('timeout')) bar.classList.add('wrong');
}

function setTilesDisabled(disabled) {
  document.getElementById('dominoBoard').style.pointerEvents = disabled ? 'none' : 'auto';
}

function clearTileStates() {
  document.querySelectorAll('.domino-tile').forEach(el =>
    el.classList.remove('flashing', 'flash-orange', 'selected', 'correct-tile', 'wrong-tile'));
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ‚ïê‚ïê‚ïê TIMER BAR ‚ïê‚ïê‚ïê
function showTimerBar(duration) {
  const container = document.getElementById('timerBarContainer');
  const bar = document.getElementById('timerBar');
  if (!duration || duration === Infinity) { container.classList.add('hidden'); return; }
  container.classList.remove('hidden');
  bar.style.width = '100%'; bar.classList.remove('warning');
  timerStart = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const elapsed = Date.now() - timerStart;
    const pct = Math.max(0, 1 - elapsed / duration) * 100;
    bar.style.width = pct + '%';
    if (pct < 30) bar.classList.add('warning');
    if (pct <= 0) clearInterval(timerInterval);
  }, 50);
}

function hideTimerBar() {
  clearInterval(timerInterval);
  document.getElementById('timerBarContainer').classList.add('hidden');
}

function resetTimerBar() {
  const bar = document.getElementById('timerBar');
  bar.style.width = '100%'; bar.classList.remove('warning');
  timerStart = Date.now();
}

// ‚ïê‚ïê‚ïê SECUENCIA ROUND ‚ïê‚ïê‚ïê
async function startSecuenciaRound() {
  clearTileStates(); playerInput = [];
  currentSequence = generateSequence(sequenceLength);
  updateUI(); hideTimerBar();

  isFlashing = true;
  setStatus('status-watching');
  setTilesDisabled(true);
  await sleep(500);

  for (let i = 0; i < currentSequence.length; i++) {
    const tileEl = document.querySelector(`[data-index="${currentSequence[i]}"]`);
    tileEl.classList.add('flashing');
    await sleep(SPEEDS[speed]);
    tileEl.classList.remove('flashing');
    if (i < currentSequence.length - 1) await sleep(GAPS[speed]);
  }

  isFlashing = false; isPlayerTurn = true;
  setStatus('status-your-turn');
  setTilesDisabled(false);
  updateSequenceDots();

  const time = RESPONSE_TIMES[responseLevel];
  startResponseTimer(time);
  showTimerBar(time);
}

// ‚ïê‚ïê‚ïê REL√ÅMPAGO ROUND ‚ïê‚ïê‚ïê
async function startRelampagoRound() {
  clearTileStates(); playerInput = [];
  const max = Math.min(sequenceLength, 10);
  currentSequence = generateSequence(max);
  updateUI(); hideTimerBar();

  isFlashing = true;
  setStatus('status-watching-rel');
  setTilesDisabled(true);
  await sleep(500);

  currentSequence.forEach(idx => {
    document.querySelector(`[data-index="${idx}"]`).classList.add('flashing');
  });
  await sleep(RELAMPAGO_FLASH[relampagoLevel]);
  currentSequence.forEach(idx => {
    document.querySelector(`[data-index="${idx}"]`).classList.remove('flashing');
  });

  isFlashing = false; isPlayerTurn = true;
  setStatus('status-your-turn-rel');
  setTilesDisabled(false);
  updateSequenceDots();

  startResponseTimer(RELAMPAGO_RESPONSE);
  showTimerBar(RELAMPAGO_RESPONSE);
}

// ‚ïê‚ïê‚ïê TRAMPA ROUND ‚ïê‚ïê‚ïê
async function startTrampaRound() {
  clearTileStates(); playerInput = [];
  hideTimerBar();

  // Generate original sequence
  trampaOriginal = generateSequence(sequenceLength);

  // Pick a random position to swap
  const swapPos = Math.floor(Math.random() * sequenceLength);
  // Get a tile not in the original sequence
  const usedSet = new Set(trampaOriginal);
  const available = [...Array(28).keys()].filter(i => !usedSet.has(i));
  trampaImpostor = available[Math.floor(Math.random() * available.length)];

  // Build modified sequence
  trampaModified = [...trampaOriginal];
  trampaModified[swapPos] = trampaImpostor;

  isFlashing = true;
  setTilesDisabled(true);

  // ‚îÄ‚îÄ FIRST PASS (gold) ‚îÄ‚îÄ
  setStatus('status-watching-tra');
  await sleep(600);

  const spd = SPEEDS[trampaSpeed];
  const gap = GAPS[trampaSpeed];

  for (let i = 0; i < trampaOriginal.length; i++) {
    const tileEl = document.querySelector(`[data-index="${trampaOriginal[i]}"]`);
    tileEl.classList.add('flashing');
    await sleep(spd);
    tileEl.classList.remove('flashing');
    if (i < trampaOriginal.length - 1) await sleep(gap);
  }

  // Brief pause between passes
  await sleep(600);

  // ‚îÄ‚îÄ SECOND PASS (orange) ‚îÄ‚îÄ
  setStatus('status-watching-tra2');
  await sleep(400);

  for (let i = 0; i < trampaModified.length; i++) {
    const tileEl = document.querySelector(`[data-index="${trampaModified[i]}"]`);
    tileEl.classList.add('flash-orange');
    await sleep(spd);
    if (i < trampaModified.length - 1) await sleep(gap);
  }

  // Keep second pass tiles highlighted ‚Äî player picks the impostor from these
  isFlashing = false; isPlayerTurn = true;
  setStatus('status-your-turn-tra');
  setTilesDisabled(false);

  startResponseTimer(TRAMPA_RESPONSE);
  showTimerBar(TRAMPA_RESPONSE);
}

// ‚ïê‚ïê‚ïê START ROUND (dispatcher) ‚ïê‚ïê‚ïê
async function startRound() {
  if (isFlashing || isPlayerTurn) return;
  document.getElementById('actionBtn').style.display = 'none';

  if (gameMode === 'secuencia') await startSecuenciaRound();
  else if (gameMode === 'relampago') await startRelampagoRound();
  else await startTrampaRound();
}

// ‚ïê‚ïê‚ïê RESPONSE TIMER ‚ïê‚ïê‚ïê
function startResponseTimer(time) {
  clearTimeout(responseTimer);
  if (!time || time === Infinity) return;
  responseTimer = setTimeout(() => {
    if (isPlayerTurn) {
      isPlayerTurn = false;
      setTilesDisabled(true);
      setStatus('status-timeout');
      hideTimerBar();
      handleFailure();
    }
  }, time);
}

// ‚ïê‚ïê‚ïê TAP HANDLER ‚ïê‚ïê‚ïê
function handleTap(idx) {
  if (!isPlayerTurn) return;
  if (gameMode === 'secuencia') handleSecuenciaTap(idx);
  else if (gameMode === 'relampago') handleRelampagoTap(idx);
  else handleTrampaTap(idx);
}

function handleSecuenciaTap(idx) {
  clearTimeout(responseTimer);
  const time = RESPONSE_TIMES[responseLevel];
  startResponseTimer(time);
  resetTimerBar();

  const expected = currentSequence[playerInput.length];
  const tileEl = document.querySelector(`[data-index="${idx}"]`);

  if (idx === expected) {
    tileEl.classList.add('selected');
    playerInput.push(idx);
    updateSequenceDots();
    if (playerInput.length === currentSequence.length) {
      isPlayerTurn = false;
      clearTimeout(responseTimer);
      setTilesDisabled(true);
      hideTimerBar();
      handleSuccess();
    }
  } else {
    tileEl.classList.add('wrong-tile');
    document.querySelector(`[data-index="${expected}"]`).classList.add('correct-tile');
    isPlayerTurn = false;
    clearTimeout(responseTimer);
    setTilesDisabled(true);
    hideTimerBar();
    setStatus('status-wrong');
    handleFailure();
  }
}

function handleRelampagoTap(idx) {
  const tileEl = document.querySelector(`[data-index="${idx}"]`);
  if (playerInput.includes(idx)) {
    playerInput = playerInput.filter(i => i !== idx);
    tileEl.classList.remove('selected');
    updateSequenceDots();
    return;
  }
  if (playerInput.length >= sequenceLength) return;
  playerInput.push(idx);
  tileEl.classList.add('selected');
  updateSequenceDots();
  if (playerInput.length === sequenceLength) {
    setTimeout(() => checkRelampagoAnswer(), 300);
  }
}

function checkRelampagoAnswer() {
  isPlayerTurn = false;
  clearTimeout(responseTimer);
  setTilesDisabled(true);
  hideTimerBar();

  const correctSet = new Set(currentSequence);
  const playerSet = new Set(playerInput);
  let allCorrect = true;

  playerInput.forEach(idx => {
    const tileEl = document.querySelector(`[data-index="${idx}"]`);
    if (correctSet.has(idx)) {
      tileEl.classList.remove('selected'); tileEl.classList.add('correct-tile');
    } else {
      tileEl.classList.remove('selected'); tileEl.classList.add('wrong-tile');
      allCorrect = false;
    }
  });
  currentSequence.forEach(idx => {
    if (!playerSet.has(idx)) {
      document.querySelector(`[data-index="${idx}"]`).classList.add('flashing');
      allCorrect = false;
    }
  });

  if (allCorrect) handleSuccess();
  else { setStatus('status-wrong'); handleFailure(); }
}

function handleTrampaTap(idx) {
  isPlayerTurn = false;
  clearTimeout(responseTimer);
  setTilesDisabled(true);
  hideTimerBar();

  const tileEl = document.querySelector(`[data-index="${idx}"]`);

  if (idx === trampaImpostor) {
    // Correct! Show the impostor as correct
    tileEl.classList.add('correct-tile');
    handleSuccess();
  } else {
    // Wrong! Show what they picked as wrong, show the real impostor
    tileEl.classList.add('wrong-tile');
    document.querySelector(`[data-index="${trampaImpostor}"]`).classList.add('correct-tile');
    setStatus('status-wrong');
    handleFailure();
  }
}

// ‚ïê‚ïê‚ïê SUCCESS / FAILURE ‚ïê‚ïê‚ïê
function handleSuccess() {
  const minLen = gameMode === 'trampa' ? 4 : 3;
  const maxLen = gameMode === 'relampago' ? 10 : 28;

  let multiplier, responseBonus;
  if (gameMode === 'secuencia') {
    multiplier = speed === 'fast' ? 3 : speed === 'medium' ? 2 : 1;
    responseBonus = responseLevel === 'pressure' ? 2 : responseLevel === 'normal' ? 1.5 : 1;
  } else if (gameMode === 'relampago') {
    multiplier = relampagoLevel === 3 ? 3 : relampagoLevel === 2 ? 2 : 1;
    responseBonus = 1;
  } else {
    multiplier = trampaSpeed === 'fast' ? 3 : trampaSpeed === 'medium' ? 2 : 1;
    responseBonus = 1.5; // Trampa is harder by nature
  }
  score += Math.round(sequenceLength * multiplier * responseBonus);
  consecutiveWins++;

  if (gameMode === 'secuencia' || gameMode === 'relampago') {
    currentSequence.forEach(idx => {
      const el = document.querySelector(`[data-index="${idx}"]`);
      el.classList.remove('selected', 'flashing');
      el.classList.add('correct-tile');
    });
  }

  if (consecutiveWins >= 2 && sequenceLength < maxLen) {
    sequenceLength++;
    consecutiveWins = 0;
    if (sequenceLength > bestSequence) bestSequence = sequenceLength;
    setStatus('status-levelup', ` ${sequenceLength}`);
  } else {
    setStatus('status-correct');
  }
  updateUI();
  showNextButton();
}

function handleFailure() {
  const minLen = gameMode === 'trampa' ? 4 : 3;
  consecutiveWins = 0;
  if (sequenceLength > minLen) sequenceLength--;
  updateUI();
  showNextButton();
}

function showNextButton() {
  const btn = document.getElementById('actionBtn');
  btn.textContent = t('btn-next');
  btn.style.display = '';
  btn.onclick = () => { clearTileStates(); startRound(); };
}

function resetGame() {
  clearTimeout(responseTimer);
  hideTimerBar();
  isFlashing = false; isPlayerTurn = false;
  const minLen = gameMode === 'trampa' ? 4 : 3;
  sequenceLength = minLen;
  consecutiveWins = 0; score = 0; bestSequence = minLen;
  playerInput = []; currentSequence = [];
  trampaOriginal = []; trampaModified = []; trampaImpostor = -1;
  clearTileStates(); setTilesDisabled(true);
  setStatus('status-ready');
  updateUI();
  const btn = document.getElementById('actionBtn');
  btn.textContent = t('btn-start');
  btn.style.display = '';
  btn.onclick = () => startRound();
}

function toggleHelp() {
  document.getElementById('helpModal').classList.toggle('hidden');
  syncHelpContent();
}

function backToWelcome() {
  clearTimeout(responseTimer);
  hideTimerBar();
  isFlashing = false;
  isPlayerTurn = false;
  clearTileStates();
  document.getElementById('dominoBoard').style.pointerEvents = 'none';
  document.getElementById('welcomeScreen').classList.remove('hidden');
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
buildBoard();
updateUI();
</script>
</body>
</html>
