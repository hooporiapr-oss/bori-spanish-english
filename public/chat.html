<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Talk to Hey Bori ‚Äî your private digital assistant for learning Spanish and English. Puerto Rico is Spanish USA.">
  <title>Hey Bori ‚Äî Chat | Learn Spanish & English</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --body:'Nunito',system-ui,sans-serif;
      --bg:#FFFDF8;--white:#FFFFFF;--dark:#1A1A1A;--text:#2A2A2A;--text-2:#5A5A5A;--text-3:#999999;
      --border:#EDE8DF;--warm:#F8F4ED;--sun:#FF6B35;--sun-dark:#E55A25;--sun-light:rgba(255,107,53,0.1);
      --green:#2A9D6E;--red:#E74C3C;
    }
    html,body{height:100%;overflow:hidden}
    body{font-family:var(--body);background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;font-size:17px}
    .app{display:flex;flex-direction:column;height:100dvh;max-width:700px;margin:0 auto}

    /* HEADER */
    .hdr{display:flex;align-items:center;gap:12px;padding:16px 18px;background:var(--white);border-bottom:1px solid var(--border);flex-shrink:0}
    .hdr-back{text-decoration:none;font-size:26px;color:var(--text-2);padding:4px 8px;border-radius:8px;transition:background .2s}
    .hdr-back:hover{background:var(--warm)}
    .hdr-av{width:48px;height:48px;border-radius:50%;background:transparent;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden}
    .hdr-info{flex:1}
    .hdr-name{font-size:19px;font-weight:800;color:var(--dark)}.hdr-name .hey{color:var(--sun)}
    .hdr-sub{font-size:13px;color:var(--text-3);font-weight:600}
    .hdr-actions{display:flex;align-items:center;gap:10px}
    .share-btn{width:40px;height:40px;border-radius:50%;background:var(--warm);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;font-size:18px}
    .share-btn:hover{background:var(--sun-light);border-color:var(--sun)}
    .hdr-lang-wrap{display:flex;flex-direction:column;align-items:center;gap:3px}
    .hdr-lang-label{font-size:10px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:0.5px}
    .hdr-lang{display:flex;border-radius:50px;overflow:hidden;border:2px solid var(--border);background:var(--white)}
    .hdr-lang-btn{padding:6px 14px;font-size:13px;font-weight:800;border:none;cursor:pointer;background:transparent;color:var(--text-3);transition:all .2s;font-family:var(--body)}
    .hdr-lang-btn.active{background:var(--sun);color:var(--white)}

    /* CHAT */
    .chat{flex:1;overflow-y:auto;padding:20px 16px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}
    .welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;padding:40px 20px;gap:18px}
    .w-av{width:200px;height:200px;border-radius:0;background:transparent;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .w-desc{font-size:17px;color:var(--text-2);max-width:380px;line-height:1.65}
    .row{display:flex;gap:10px;align-items:flex-start;max-width:90%}
    .row-bori{align-self:flex-start}.row-user{align-self:flex-end;flex-direction:row-reverse}
    .av{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;margin-top:2px}
    .av-bori{background:transparent;overflow:hidden}.av-user{background:var(--green);color:var(--white)}
    .bub{padding:14px 18px;border-radius:20px;font-size:17px;line-height:1.65;word-wrap:break-word;white-space:pre-wrap}
    .bub-bori{background:var(--warm);color:var(--text);border-bottom-left-radius:6px}
    .bub-user{background:var(--sun);color:var(--white);border-bottom-right-radius:6px;font-weight:600}
    .bub-err{background:#FFF0F0;color:#C0392B;border-bottom-left-radius:6px}
    .dots{display:flex;gap:10px;align-items:flex-start;align-self:flex-start}
    .dots .av{width:38px;height:38px;border-radius:50%;background:transparent;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .hdr-av img,.w-av img,.av-bori img,.dots .av img{width:100%;height:100%;object-fit:cover}
    .dots-bub{padding:14px 20px;border-radius:20px;background:var(--warm);border-bottom-left-radius:6px;display:flex;gap:6px;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--text-3);animation:dotPulse 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes dotPulse{0%,100%{opacity:.3;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}

    /* COUNTER */
    .counter-bar{text-align:center;padding:8px 18px;font-size:13px;font-weight:700;color:var(--text-3);background:var(--bg);border-top:1px solid var(--border);flex-shrink:0}
    .counter-bar .count{color:var(--sun);font-weight:900}
    .counter-bar.low .count{color:var(--red)}

    /* INPUT */
    .input-bar{display:flex;align-items:flex-end;gap:10px;padding:12px 16px 16px;background:var(--white);border-top:1px solid var(--border);flex-shrink:0}
    .input-bar textarea{flex:1;border:1.5px solid var(--border);border-radius:24px;padding:13px 20px;font-size:17px;font-family:var(--body);resize:none;outline:none;max-height:120px;line-height:1.45;color:var(--text);background:var(--bg);transition:border .2s}
    .input-bar textarea::placeholder{color:var(--text-3)}
    .input-bar textarea:focus{border-color:var(--sun)}
    .input-bar.disabled textarea{opacity:.4;pointer-events:none}
    .input-bar.disabled .send-btn{opacity:.2;pointer-events:none}
    .send-btn{width:48px;height:48px;border-radius:50%;background:var(--sun);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
    .send-btn:hover:not(:disabled){background:var(--sun-dark);transform:scale(1.05)}
    .send-btn:disabled{opacity:.4;cursor:default}
    .send-btn svg{width:22px;height:22px;fill:var(--white)}

    /* LIMIT OVERLAY */
    .limit-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
    .limit-overlay.show{display:flex}
    .limit-card{background:var(--white);border-radius:24px;padding:44px 32px;max-width:400px;width:92%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.15)}
    .limit-icon{font-size:56px;margin-bottom:18px}
    .limit-card h2{font-size:22px;font-weight:800;color:var(--dark);margin-bottom:10px}
    .limit-card p{font-size:16px;color:var(--text-2);line-height:1.65;margin-bottom:22px}
    .limit-timer{font-size:34px;font-weight:900;color:var(--sun);margin-bottom:22px;letter-spacing:2px}
    .limit-share{display:inline-block;padding:14px 36px;border-radius:50px;background:var(--sun);color:var(--white);font-size:17px;font-weight:800;cursor:pointer;border:none;font-family:var(--body);transition:all .2s;margin-bottom:12px}
    .limit-share:hover{background:var(--sun-dark);transform:translateY(-1px)}
    .limit-close{display:inline-block;padding:10px 24px;font-size:15px;color:var(--text-3);cursor:pointer;font-weight:700;background:none;border:none;font-family:var(--body)}
    .limit-close:hover{color:var(--dark)}

    /* TOAST */
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--dark);color:var(--white);padding:12px 28px;border-radius:50px;font-size:15px;font-weight:700;opacity:0;transition:all .3s;z-index:300;pointer-events:none}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    @supports(padding-bottom:env(safe-area-inset-bottom)){.input-bar{padding-bottom:calc(14px + env(safe-area-inset-bottom))}}
  </style>
</head>
<body>

  <div class="app">
    <div class="hdr">
      <a href="/" class="hdr-back" title="Back">‚Üê</a>
      <div class="hdr-av"><img src="/icon.png" alt="Hey Bori"></div>
      <div class="hdr-info">
        <div class="hdr-name"><span class="hey">Hey</span> Bori</div>
        <div class="hdr-sub" id="hdr-sub" data-en="Your language companion" data-es="Tu companero de idioma">Your language companion</div>
      </div>
      <div class="hdr-actions">
        <button class="share-btn" onclick="doShare()" title="Share">üì§</button>
        <div class="hdr-lang-wrap">
          <div class="hdr-lang-label" id="langLabel" data-en="Pick Your Language" data-es="Escoge Tu Idioma">Pick Your Language</div>
          <div class="hdr-lang">
            <button class="hdr-lang-btn active" id="btn-en" onclick="setLang('en')">English</button>
            <button class="hdr-lang-btn" id="btn-es" onclick="setLang('es')">Espa√±ol</button>
          </div>
        </div>
      </div>
    </div>

    <div class="chat" id="chat">
      <div class="welcome" id="welcome">
        <div class="w-av"><img src="/icon.png" alt="Hey Bori"></div>
        <div class="w-desc" id="w-desc" data-en="Your private digital assistant for learning Spanish and English with confidence. Just start talking!" data-es="Tu asistente digital privado para aprender espanol e ingles con confianza. Solo empieza a hablar!">Your private digital assistant for learning Spanish and English with confidence. Just start talking!</div>
      </div>
    </div>

    <div class="counter-bar" id="counterBar">
      <span id="counterText"><span class="count">0</span> / 10 messages today</span>
    </div>

    <div class="input-bar" id="inputBar">
      <textarea id="inp" rows="1" placeholder="Type a message..." data-en="Type a message..." data-es="Escribe un mensaje..."></textarea>
      <button class="send-btn" id="sendBtn" onclick="doSend()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

  <div class="limit-overlay" id="limitOverlay">
    <div class="limit-card">
      <div class="limit-icon">üáµüá∑</div>
      <h2 id="limitTitle" data-en="Great conversations today!" data-es="Buenas conversaciones hoy!">Great conversations today!</h2>
      <p id="limitDesc" data-en="You've used all 10 free messages for today. Hey Bori resets at midnight ‚Äî come back tomorrow to keep learning!" data-es="Usaste tus 10 mensajes gratis de hoy. Hey Bori se reinicia a medianoche ‚Äî vuelve manana pa' seguir aprendiendo!">You've used all 10 free messages for today. Hey Bori resets at midnight ‚Äî come back tomorrow to keep learning!</p>
      <div class="limit-timer" id="limitTimer">--:--:--</div>
      <button class="limit-share" onclick="doShare()" id="limitShareBtn" data-en="Share Hey Bori with a friend" data-es="Comparte Hey Bori con alguien">Share Hey Bori with a friend</button><br>
      <button class="limit-close" onclick="closeLimitOverlay()" id="limitCloseBtn" data-en="Close" data-es="Cerrar">Close</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    var chat=document.getElementById('chat'),inp=document.getElementById('inp'),sendBtn=document.getElementById('sendBtn');
    var counterBar=document.getElementById('counterBar'),inputBar=document.getElementById('inputBar');
    var limitOverlay=document.getElementById('limitOverlay');
    var hist=[],busy=false,lang='en',MAX_MSGS=10;

    // ‚ïê‚ïê‚ïê DAILY LIMIT ‚ïê‚ïê‚ïê
    function getTodayKey(){var d=new Date();return 'bori-msgs-'+d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();}
    function getMsgCount(){try{var v=localStorage.getItem(getTodayKey());return v?parseInt(v,10):0;}catch(e){return 0;}}
    function incMsgCount(){
      try{
        var key=getTodayKey(),count=getMsgCount()+1;
        localStorage.setItem(key,count.toString());
        for(var i=localStorage.length-1;i>=0;i--){var k=localStorage.key(i);if(k&&k.startsWith('bori-msgs-')&&k!==key)localStorage.removeItem(k);}
        return count;
      }catch(e){return 0;}
    }
    function isLimitReached(){return getMsgCount()>=MAX_MSGS;}

    function updateCounter(){
      var count=getMsgCount(),remaining=MAX_MSGS-count;
      var ct=document.getElementById('counterText');
      ct.innerHTML=lang==='es'
        ?'<span class="count">'+count+'</span> / '+MAX_MSGS+' mensajes hoy'
        :'<span class="count">'+count+'</span> / '+MAX_MSGS+' messages today';
      counterBar.className=remaining<=2&&remaining>0?'counter-bar low':'counter-bar';
      if(isLimitReached()){
        inputBar.className='input-bar disabled';
        inp.placeholder=lang==='es'?'Limite diario alcanzado':'Daily limit reached';
      }else{
        inputBar.className='input-bar';
        inp.placeholder=lang==='es'?'Escribe un mensaje...':'Type a message...';
      }
    }

    // ‚ïê‚ïê‚ïê COUNTDOWN ‚ïê‚ïê‚ïê
    function getTimeToMidnight(){
      var now=new Date(),mn=new Date(now);mn.setHours(24,0,0,0);var d=mn-now;
      var h=Math.floor(d/3600000),m=Math.floor((d%3600000)/60000),s=Math.floor((d%60000)/1000);
      return(h<10?'0':'')+h+':'+(m<10?'0':'')+m+':'+(s<10?'0':'')+s;
    }
    setInterval(function(){
      document.getElementById('limitTimer').textContent=getTimeToMidnight();
      if(!isLimitReached()&&limitOverlay.classList.contains('show')){closeLimitOverlay();updateCounter();}
    },1000);

    // ‚ïê‚ïê‚ïê OVERLAY ‚ïê‚ïê‚ïê
    function showLimitOverlay(){limitOverlay.className='limit-overlay show';}
    function closeLimitOverlay(){limitOverlay.className='limit-overlay';}

    // ‚ïê‚ïê‚ïê SHARE ‚ïê‚ïê‚ïê
    function doShare(){
      var url=window.location.origin+'/chat';
      var t=lang==='es'
        ?'Estoy aprendiendo espanol e ingles con Hey Bori ‚Äî pruebalo! üáµüá∑ '+url
        :'I\'m learning Spanish & English with Hey Bori ‚Äî try it! üáµüá∑ '+url;
      if(navigator.share){navigator.share({title:'Hey Bori',text:t,url:url}).catch(function(){});}
      else{navigator.clipboard.writeText(t).then(function(){showToast(lang==='es'?'Enlace copiado!':'Link copied!');}).catch(function(){});}
    }
    function showToast(msg){var t=document.getElementById('toast');t.textContent=msg;t.className='toast show';setTimeout(function(){t.className='toast';},2500);}

    // ‚ïê‚ïê‚ïê LANGUAGE ‚ïê‚ïê‚ïê
    function setLang(l){
      lang=l;
      document.getElementById('btn-en').className='hdr-lang-btn'+(l==='en'?' active':'');
      document.getElementById('btn-es').className='hdr-lang-btn'+(l==='es'?' active':'');
      var els=document.querySelectorAll('[data-'+l+']');
      for(var i=0;i<els.length;i++){
        var el=els[i],val=el.getAttribute('data-'+l);
        if(val&&el.tagName==='TEXTAREA')el.placeholder=val;
        else if(val&&!el.classList.contains('hdr-lang-btn'))el.textContent=val;
      }
      updateCounter();
    }

    // ‚ïê‚ïê‚ïê INPUT ‚ïê‚ïê‚ïê
    inp.addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px';});
    inp.addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();doSend();}});

    function clearWelcome(){var w=document.getElementById('welcome');if(w)w.remove();}

    function addBub(who,text,isErr){
      clearWelcome();
      var r=document.createElement('div');r.className='row row-'+who;
      var a=document.createElement('div');a.className='av av-'+who;
      if(who==='bori')a.innerHTML='<img src="/icon.png" alt="Bori">';else a.textContent='üë§';
      var b=document.createElement('div');b.className=isErr?'bub bub-err':'bub bub-'+who;
      b.textContent=text;r.appendChild(a);r.appendChild(b);chat.appendChild(r);chat.scrollTop=chat.scrollHeight;
    }

    function addDots(){
      var d=document.createElement('div');d.className='dots';d.id='dots';
      d.innerHTML='<div class="av"><img src="/icon.png" alt="Bori"></div><div class="dots-bub"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
      chat.appendChild(d);chat.scrollTop=chat.scrollHeight;
    }
    function killDots(){var d=document.getElementById('dots');if(d)d.remove();}

    // ‚ïê‚ïê‚ïê SEND ‚ïê‚ïê‚ïê
    window.doSend=async function(){
      var text=inp.value.trim();
      if(!text||busy)return;
      if(isLimitReached()){showLimitOverlay();return;}

      busy=true;sendBtn.disabled=true;inp.value='';inp.style.height='auto';
      addBub('user',text);hist.push({role:'user',content:text});
      incMsgCount();updateCounter();addDots();

      try{
        var ctrl=new AbortController();var tmout=setTimeout(function(){ctrl.abort();},45000);
        var res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,history:hist.slice(-20),lang:lang}),signal:ctrl.signal});
        clearTimeout(tmout);killDots();

        if(!res.ok||!res.body){
          addBub('bori',lang==='es'?'Se fue el tiempo. Intenta de nuevo.':'Had a timeout. Try again.',true);
          busy=false;sendBtn.disabled=false;return;
        }

        clearWelcome();
        var r=document.createElement('div');r.className='row row-bori';
        var a=document.createElement('div');a.className='av av-bori';a.innerHTML='<img src="/icon.png" alt="Bori">';
        var b=document.createElement('div');b.className='bub bub-bori';b.textContent='';
        r.appendChild(a);r.appendChild(b);chat.appendChild(r);

        var fullReply='',reader=res.body.getReader(),decoder=new TextDecoder(),buffer='';
        while(true){
          var result=await reader.read();if(result.done)break;
          buffer+=decoder.decode(result.value,{stream:true});
          var lines=buffer.split('\n');buffer=lines.pop()||'';
          for(var i=0;i<lines.length;i++){
            var line=lines[i].trim();if(!line.startsWith('data: '))continue;
            try{var evt=JSON.parse(line.slice(6));
              if(evt.type==='text'){fullReply+=evt.text;b.textContent=fullReply;chat.scrollTop=chat.scrollHeight;}
              else if(evt.type==='error'&&!fullReply){b.className='bub bub-err';b.textContent=evt.error||'Something went wrong.';}
            }catch(pe){}
          }
        }
        if(!fullReply){b.className='bub bub-err';b.textContent=lang==='es'?'No recibi respuesta. Intenta de nuevo.':'No response received. Try again.';}
        hist.push({role:'assistant',content:fullReply});if(hist.length>40)hist=hist.slice(-40);

        // Show limit overlay after last message
        if(isLimitReached())setTimeout(function(){showLimitOverlay();},1500);

      }catch(e){
        killDots();
        addBub('bori',e.name==='AbortError'
          ?(lang==='es'?'Se agoto el tiempo. Intenta de nuevo.':'Request timed out. Try again.')
          :(lang==='es'?'Problema de conexion. Intenta de nuevo.':'Connection issue. Try again.'),true);
      }
      busy=false;sendBtn.disabled=false;inp.focus();
    };

    // ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
    updateCounter();
    if(isLimitReached())showLimitOverlay();
  </script>
</body>
</html>
