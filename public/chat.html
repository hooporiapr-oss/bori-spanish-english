<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Hey Bori ‚Äî Chat</title>
  <link rel="icon" type="image/png" href="/icon-01F.png">
  <link rel="apple-touch-icon" href="/icon-01F.png">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--body:'Nunito',sans-serif;--bg:#FFFDF8;--white:#FFF;--dark:#1A1A1A;--text:#2A2A2A;--text-2:#5A5A5A;--text-3:#999;--border:#EDE8DF;--warm:#F8F4ED;--sun:#FF6B35;--sun-dark:#E55A25;--sun-light:rgba(255,107,53,0.1);--green:#2A9D6E;--red:#E74C3C}
html,body{height:100%;overflow:hidden}
body{font-family:var(--body);background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.app{display:flex;flex-direction:column;height:100dvh;max-width:700px;margin:0 auto}
.hdr{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--white);border-bottom:1px solid var(--border);flex-shrink:0}
.hdr-back{text-decoration:none;font-size:24px;color:var(--text-2);padding:2px 6px;border-radius:8px}
.hdr-av{width:52px;height:52px;flex-shrink:0;overflow:hidden;transition:transform .3s}
.hdr-av img{width:100%;height:100%;object-fit:contain}
.hdr-info{flex:1}
.hdr-name{font-size:18px;font-weight:800;color:var(--dark)}.hdr-name .hey{color:var(--sun)}
.hdr-sub{font-size:12px;color:var(--text-3);font-weight:600}
.share-btn{width:38px;height:38px;border-radius:50%;background:var(--warm);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:17px;transition:all .2s;flex-shrink:0}
.share-btn:hover{background:var(--sun-light);border-color:var(--sun)}
.burger{width:38px;height:38px;border-radius:50%;background:var(--warm);border:1px solid var(--border);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;-webkit-tap-highlight-color:transparent}
.burger:active{transform:scale(.95)}
.burger-line{width:16px;height:2.5px;background:var(--sun);border-radius:2px;transition:all .3s}
.burger.open .burger-line:nth-child(1){transform:rotate(45deg) translate(4px,4px)}
.burger.open .burger-line:nth-child(2){opacity:0}
.burger.open .burger-line:nth-child(3){transform:rotate(-45deg) translate(4px,-4px)}
.menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:100;opacity:0;pointer-events:none;transition:opacity .3s}
.menu-overlay.open{opacity:1;pointer-events:auto}
.menu{position:fixed;top:0;right:-280px;width:280px;height:100%;background:var(--white);z-index:101;transition:right .3s cubic-bezier(.22,1,.36,1);box-shadow:-4px 0 24px rgba(0,0,0,0.1);display:flex;flex-direction:column;padding:28px 0;overflow-y:auto}
.menu.open{right:0}
.menu-header{padding:0 24px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.menu-header img{width:40px;height:40px;object-fit:contain}
.menu-header-text{flex:1}
.menu-header-title{font-size:18px;font-weight:900;color:var(--dark)}.menu-header-title .hey{color:var(--sun)}
.menu-header-sub{font-size:11px;color:var(--text-3);font-weight:600}
.menu-section{padding:18px 24px 8px;font-size:10px;font-weight:800;color:var(--text-3);text-transform:uppercase;letter-spacing:1.5px}
.menu-link{display:flex;align-items:center;gap:14px;padding:14px 24px;text-decoration:none;color:var(--text);font-size:16px;font-weight:700;transition:background .15s;-webkit-tap-highlight-color:transparent}
.menu-link:active{background:var(--warm)}
.menu-link-icon{font-size:22px;width:30px;text-align:center}
.menu-link-arrow{color:var(--text-3);font-size:14px;margin-left:auto}
.menu-spacer{flex:1}
.menu-footer{padding:16px 24px;border-top:1px solid var(--border)}
.menu-footer a{font-size:12px;color:var(--text-3);text-decoration:none;font-weight:600;margin-right:14px}
.menu-footer a:active{color:var(--sun)}
.menu-footer p{font-size:10px;color:var(--text-3);margin-top:8px;opacity:.5}
.toggle-bar{display:flex;align-items:center;justify-content:center;gap:10px;padding:8px 16px;background:var(--white);border-bottom:1px solid var(--border);flex-shrink:0}
.lang-label{font-size:10px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px}
.lang-toggle{display:flex;border-radius:50px;overflow:hidden;border:2px solid var(--border);background:var(--bg)}
.lang-btn{padding:5px 14px;font-size:13px;font-weight:800;border:none;cursor:pointer;background:transparent;color:var(--text-3);transition:all .2s;font-family:var(--body)}
.lang-btn.active{background:var(--sun);color:var(--white)}
.chat{flex:1;overflow-y:auto;padding:16px 14px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;padding:20px 16px;gap:14px}
.w-av{width:220px;height:220px}.w-av img{width:100%;height:100%;object-fit:contain}
.w-desc{font-size:20px;color:var(--dark);max-width:340px;line-height:1.5;font-weight:900}
.row{display:flex;gap:8px;align-items:flex-start;max-width:92%}
.row-bori{align-self:flex-start}.row-user{align-self:flex-end;flex-direction:row-reverse}
.av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;margin-top:2px}
.av-bori{background:transparent;overflow:hidden}.av-user{background:var(--green);color:var(--white)}
.av-bori img{width:100%;height:100%;object-fit:contain}
.bub{padding:12px 16px;border-radius:20px;font-size:17px;line-height:1.6;word-wrap:break-word;white-space:pre-wrap}
.bub-bori{background:var(--warm);color:var(--text);border-bottom-left-radius:6px;position:relative}
.bub-user{background:var(--sun);color:var(--white);border-bottom-right-radius:6px;font-weight:600}
.bub-err{background:#FFF0F0;color:#C0392B;border-bottom-left-radius:6px}
.dots{display:flex;gap:8px;align-items:flex-start;align-self:flex-start}
.dots .av{width:32px;height:32px;background:transparent;overflow:hidden}
.dots .av img{width:100%;height:100%;object-fit:contain}
.dots-bub{padding:14px 20px;border-radius:20px;background:var(--warm);border-bottom-left-radius:6px;display:flex;gap:6px;align-items:center}
.dot{width:8px;height:8px;border-radius:50%;background:var(--text-3);animation:dp 1.2s infinite}
.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
@keyframes dp{0%,100%{opacity:.3;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
.counter-bar{text-align:center;padding:6px 16px;font-size:12px;font-weight:700;color:var(--text-3);background:var(--bg);border-top:1px solid var(--border);flex-shrink:0}
.counter-bar .count{color:var(--sun);font-weight:900}
.counter-bar.low .count{color:var(--red)}
.input-bar{display:flex;align-items:flex-end;gap:8px;padding:10px 14px 14px;background:var(--white);border-top:1px solid var(--border);flex-shrink:0}
.input-bar textarea{flex:1;border:1.5px solid var(--border);border-radius:24px;padding:12px 18px;font-size:17px;font-family:var(--body);resize:none;outline:none;max-height:110px;line-height:1.4;color:var(--text);background:var(--bg);transition:border .2s}
.input-bar textarea::placeholder{color:var(--text-3)}
.input-bar textarea:focus{border-color:var(--sun)}
.input-bar.disabled textarea{opacity:.4;pointer-events:none}
.input-bar.disabled .send-btn{opacity:.2;pointer-events:none}
.send-btn{width:48px;height:48px;border-radius:50%;background:var(--sun);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
.send-btn:hover:not(:disabled){background:var(--sun-dark);transform:scale(1.05)}
.send-btn:disabled{opacity:.4;cursor:default}
.send-btn svg{width:22px;height:22px;fill:var(--white)}
.limit-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.limit-overlay.show{display:flex}
.limit-card{background:var(--white);border-radius:24px;padding:40px 28px;max-width:380px;width:92%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.15)}
.limit-icon{font-size:52px;margin-bottom:16px}
.limit-card h2{font-size:21px;font-weight:800;color:var(--dark);margin-bottom:8px}
.limit-card p{font-size:15px;color:var(--text-2);line-height:1.6;margin-bottom:20px}
.limit-timer{font-size:32px;font-weight:900;color:var(--sun);margin-bottom:20px;letter-spacing:2px}
.limit-share{display:inline-block;padding:14px 34px;border-radius:50px;background:var(--sun);color:var(--white);font-size:16px;font-weight:800;cursor:pointer;border:none;font-family:var(--body);transition:all .2s;margin-bottom:10px}
.limit-share:hover{background:var(--sun-dark)}
.limit-close{display:inline-block;padding:10px 24px;font-size:14px;color:var(--text-3);cursor:pointer;font-weight:700;background:none;border:none;font-family:var(--body)}
.limit-close:hover{color:var(--dark)}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--dark);color:var(--white);padding:12px 28px;border-radius:50px;font-size:14px;font-weight:700;opacity:0;transition:all .3s;z-index:300;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
@supports(padding-bottom:env(safe-area-inset-bottom)){.input-bar{padding-bottom:calc(14px + env(safe-area-inset-bottom))}}
  </style>
</head>
<body>
  <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
  <div class="menu" id="menu">
    <div class="menu-header"><img src="/icon.png" alt="Hey Bori"><div class="menu-header-text"><div class="menu-header-title"><span class="hey">Hey</span> Bori</div><div class="menu-header-sub" data-en="Your Digital Assistant" data-es="Tu Asistente Digital">Your Digital Assistant</div></div></div>
    <div class="menu-section" data-en="MAIN" data-es="PRINCIPAL">MAIN</div>
    <a href="/" class="menu-link"><span class="menu-link-icon">üè†</span>Home<span class="menu-link-arrow">‚Ä∫</span></a>
    <a href="/chat" class="menu-link"><span class="menu-link-icon">üí¨</span>Chat<span class="menu-link-arrow">‚Ä∫</span></a>
    <div class="menu-section" data-en="CULTURAL GAMES" data-es="JUEGOS CULTURALES">CULTURAL GAMES</div>
    <a href="/the-conga.html" class="menu-link"><span class="menu-link-icon">ü•Å</span>Conga<span class="menu-link-arrow">‚Ä∫</span></a>
    <a href="/the-lelolai.html" class="menu-link"><span class="menu-link-icon">üî§</span>LeLoLai Letras<span class="menu-link-arrow">‚Ä∫</span></a>
    <a href="/the-domino.html" class="menu-link"><span class="menu-link-icon">üé≤</span>La Marquesina<span class="menu-link-arrow">‚Ä∫</span></a>
    <a href="/the-isla.html" class="menu-link"><span class="menu-link-icon">üß©</span>La Isla<span class="menu-link-arrow">‚Ä∫</span></a>
    <div class="menu-spacer"></div>
    <div class="menu-footer"><a href="/privacy.html">Privacy</a><a href="/terms.html">Terms</a><p>¬© 2026 GoStar Digital LLC üáµüá∑</p></div>
  </div>
  <div class="app">
    <div class="hdr">
      <a href="/" class="hdr-back">‚Üê</a>
      <div class="hdr-av" id="hdrAv"><img src="/icon.png" alt="Hey Bori"></div>
      <div class="hdr-info"><div class="hdr-name"><span class="hey">Hey</span> Bori</div><div class="hdr-sub" data-en="Your Digital Assistant" data-es="Tu Asistente Digital">Your Digital Assistant</div></div>
      <button class="share-btn" onclick="doShare()">üì§</button>
      <button class="burger" id="burger" onclick="toggleMenu()"><div class="burger-line"></div><div class="burger-line"></div><div class="burger-line"></div></button>
    </div>
    <div class="toggle-bar"><span class="lang-label" data-en="Pick Your Language" data-es="Escoge Tu Idioma">Pick Your Language</span><div class="lang-toggle"><button class="lang-btn active" id="btn-en" onclick="setLang('en')">English</button><button class="lang-btn" id="btn-es" onclick="setLang('es')">Espa√±ol</button></div></div>
    <div class="chat" id="chat"><div class="welcome" id="welcome"><div class="w-av"><img src="/icon.png" alt="Hey Bori"></div><div class="w-desc" data-en="Hey Bori. Your Private Bilingual Spanish and English Digital Assistant." data-es="Hey Bori. Tu Asistente Digital Privado Biling√ºe de Espa√±ol e Ingl√©s.">Hey Bori. Your Private Bilingual Spanish and English Digital Assistant.</div></div></div>
    <div class="counter-bar" id="counterBar"><span id="counterText"><span class="count">0</span> / 10 messages today</span></div>
    <div class="input-bar" id="inputBar">
      <textarea id="inp" rows="1" placeholder="Type a message..." data-en="Type a message..." data-es="Escribe un mensaje..."></textarea>
      <button class="send-btn" id="sendBtn" onclick="doSend()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
    </div>
  </div>
  <div class="limit-overlay" id="limitOverlay"><div class="limit-card"><div class="limit-icon">üáµüá∑</div><h2 data-en="Great conversations today!" data-es="¬°Buenas conversaciones hoy!">Great conversations today!</h2><p data-en="You've used all 10 free messages for today. Hey Bori resets at midnight ‚Äî come back tomorrow to keep learning!" data-es="Usaste tus 10 mensajes gratis de hoy. Hey Bori se reinicia a medianoche ‚Äî ¬°vuelve ma√±ana pa' seguir aprendiendo!">You've used all 10 free messages for today. Hey Bori resets at midnight ‚Äî come back tomorrow to keep learning!</p><div class="limit-timer" id="limitTimer">--:--:--</div><button class="limit-share" onclick="doShare()" data-en="Share Hey Bori with a friend" data-es="Comparte Hey Bori con alguien">Share Hey Bori with a friend</button><br><button class="limit-close" onclick="closeLimitOverlay()" data-en="Close" data-es="Cerrar">Close</button></div></div>
  <div class="toast" id="toast"></div>

  <!-- ‚ïê‚ïê‚ïê ELEVENLABS CONVERSATIONAL AI WIDGET ‚ïê‚ïê‚ïê -->
  <elevenlabs-convai agent-id="agent_6201kjbe2epdev59wq92kgn49n0r"></elevenlabs-convai>
  <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>

  <script>
var chat=document.getElementById('chat'),inp=document.getElementById('inp'),sendBtn=document.getElementById('sendBtn');
var counterBar=document.getElementById('counterBar'),inputBar=document.getElementById('inputBar');
var limitOverlay=document.getElementById('limitOverlay');
var hdrAv=document.getElementById('hdrAv');
var hist=[],busy=false,lang='en',MAX_MSGS=10,isSubscriber=false;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SUBSCRIPTION CHECK
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function checkSubscription(){try{var email=localStorage.getItem('bori-email');if(!email)return;fetch('/api/stripe/status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:email})}).then(function(r){return r.json()}).then(function(data){if(data.subscribed){isSubscriber=true;MAX_MSGS=999999;counterBar.style.display='none';if(limitOverlay.classList.contains('show'))closeLimitOverlay();inputBar.className='input-bar';inp.placeholder=lang==='es'?'Escribe un mensaje...':'Type a message...';}}).catch(function(){});}catch(e){}}
(function(){var p=new URLSearchParams(window.location.search);if(p.get('upgraded')==='true'){var email=prompt(lang==='es'?'¬°Bienvenido a Bori Plus! Ingresa tu email para activar:':'Welcome to Bori Plus! Enter your email to activate:');if(email){localStorage.setItem('bori-email',email);window.history.replaceState({},'','/chat');checkSubscription();}}else{checkSubscription();}})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MENU / LANG / COUNTER / LIMITS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleMenu(){document.getElementById('burger').classList.toggle('open');document.getElementById('menu').classList.toggle('open');document.getElementById('menuOverlay').classList.toggle('open');}
function getTodayKey(){var d=new Date();return 'bori-msgs-'+d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();}
function getMsgCount(){try{var v=localStorage.getItem(getTodayKey());return v?parseInt(v,10):0;}catch(e){return 0;}}
function incMsgCount(){try{var key=getTodayKey(),count=getMsgCount()+1;localStorage.setItem(key,count.toString());for(var i=localStorage.length-1;i>=0;i--){var k=localStorage.key(i);if(k&&k.startsWith('bori-msgs-')&&k!==key)localStorage.removeItem(k);}return count;}catch(e){return 0;}}
function isLimitReached(){return getMsgCount()>=MAX_MSGS;}
function updateCounter(){var count=getMsgCount(),rem=MAX_MSGS-count;document.getElementById('counterText').innerHTML=lang==='es'?'<span class="count">'+count+'</span> / '+MAX_MSGS+' mensajes hoy':'<span class="count">'+count+'</span> / '+MAX_MSGS+' messages today';counterBar.className=rem<=2&&rem>0?'counter-bar low':'counter-bar';if(isLimitReached()){inputBar.className='input-bar disabled';inp.placeholder=lang==='es'?'L√≠mite diario alcanzado':'Daily limit reached';}else{inputBar.className='input-bar';inp.placeholder=lang==='es'?'Escribe un mensaje...':'Type a message...';}}
function getTimeToMidnight(){var now=new Date(),mn=new Date(now);mn.setHours(24,0,0,0);var d=mn-now;var h=Math.floor(d/3600000),m=Math.floor((d%3600000)/60000),s=Math.floor((d%60000)/1000);return(h<10?'0':'')+h+':'+(m<10?'0':'')+m+':'+(s<10?'0':'')+s;}
setInterval(function(){document.getElementById('limitTimer').textContent=getTimeToMidnight();if(!isLimitReached()&&limitOverlay.classList.contains('show')){closeLimitOverlay();updateCounter();}},1000);
function showLimitOverlay(){limitOverlay.className='limit-overlay show';}
function closeLimitOverlay(){limitOverlay.className='limit-overlay';}
function doShare(){var url=window.location.origin;var t=lang==='es'?'Estoy aprendiendo espa√±ol e ingl√©s con Hey Bori ‚Äî ¬°pru√©balo! üáµüá∑ '+url:'I\'m learning Spanish & English with Hey Bori ‚Äî try it! üáµüá∑ '+url;if(navigator.share){navigator.share({title:'Hey Bori',text:t,url:url}).catch(function(){});}else{navigator.clipboard.writeText(t).then(function(){showToast(lang==='es'?'¬°Enlace copiado!':'Link copied!');}).catch(function(){});}}
function showToast(msg){var t=document.getElementById('toast');t.textContent=msg;t.className='toast show';setTimeout(function(){t.className='toast';},2500);}
function setLang(l){lang=l;document.getElementById('btn-en').className='lang-btn'+(l==='en'?' active':'');document.getElementById('btn-es').className='lang-btn'+(l==='es'?' active':'');var els=document.querySelectorAll('[data-'+l+']');for(var i=0;i<els.length;i++){var el=els[i],val=el.getAttribute('data-'+l);if(val&&el.tagName==='TEXTAREA')el.placeholder=val;else if(val&&!el.classList.contains('lang-btn'))el.textContent=val;}updateCounter();}
inp.addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,110)+'px';});
inp.addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();doSend();}});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHAT BUBBLES + SEND (text chat with Claude)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function clearWelcome(){var w=document.getElementById('welcome');if(w)w.remove();}
function addBub(who,text,isErr){clearWelcome();var r=document.createElement('div');r.className='row row-'+who;var a=document.createElement('div');a.className='av av-'+who;if(who==='bori')a.innerHTML='<img src="/icon.png" alt="Bori">';else a.textContent='üë§';var b=document.createElement('div');b.className=isErr?'bub bub-err':'bub bub-'+who;b.textContent=text;r.appendChild(a);r.appendChild(b);chat.appendChild(r);chat.scrollTop=chat.scrollHeight;}
function addDots(){var d=document.createElement('div');d.className='dots';d.id='dots';d.innerHTML='<div class="av"><img src="/icon.png" alt="Bori"></div><div class="dots-bub"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}
function killDots(){var d=document.getElementById('dots');if(d)d.remove();}

window.doSend=async function(){
  var text=inp.value.trim();
  if(!text||busy)return;
  if(isLimitReached()){showLimitOverlay();return;}

  busy=true;sendBtn.disabled=true;
  inp.value='';inp.style.height='auto';

  addBub('user',text);
  hist.push({role:'user',content:text});
  incMsgCount();updateCounter();
  addDots();

  try{
    var ctrl=new AbortController();
    var tmout=setTimeout(function(){ctrl.abort();},45000);
    var res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,history:hist.slice(-20),lang:lang}),signal:ctrl.signal});
    clearTimeout(tmout);killDots();

    if(!res.ok||!res.body){addBub('bori',lang==='es'?'Se fue el tiempo. Intenta de nuevo.':'Had a timeout. Try again.',true);busy=false;sendBtn.disabled=false;return;}

    clearWelcome();
    var r=document.createElement('div');r.className='row row-bori';
    var a=document.createElement('div');a.className='av av-bori';a.innerHTML='<img src="/icon.png" alt="Bori">';
    var b=document.createElement('div');b.className='bub bub-bori';b.textContent='';
    r.appendChild(a);r.appendChild(b);chat.appendChild(r);

    var fullReply='',reader=res.body.getReader(),decoder=new TextDecoder(),buffer='';
    while(true){
      var result=await reader.read();if(result.done)break;
      buffer+=decoder.decode(result.value,{stream:true});
      var lines=buffer.split('\n');buffer=lines.pop()||'';
      for(var i=0;i<lines.length;i++){
        var line=lines[i].trim();if(!line.startsWith('data: '))continue;
        try{var evt=JSON.parse(line.slice(6));
          if(evt.type==='text'){fullReply+=evt.text;b.textContent=fullReply;chat.scrollTop=chat.scrollHeight;}
          else if(evt.type==='error'&&!fullReply){b.className='bub bub-err';b.textContent=evt.error||'Something went wrong.';}
        }catch(pe){}
      }
    }

    if(!fullReply){b.className='bub bub-err';b.textContent=lang==='es'?'No recib√≠ respuesta. Intenta de nuevo.':'No response received. Try again.';}
    hist.push({role:'assistant',content:fullReply});
    if(hist.length>40)hist=hist.slice(-40);
    if(isLimitReached())setTimeout(function(){showLimitOverlay();},1500);

  }catch(e){
    killDots();
    addBub('bori',e.name==='AbortError'?(lang==='es'?'Se agot√≥ el tiempo. Intenta de nuevo.':'Request timed out. Try again.'):(lang==='es'?'Problema de conexi√≥n. Intenta de nuevo.':'Connection issue. Try again.'),true);
  }
  busy=false;sendBtn.disabled=false;inp.focus();
};

updateCounter();if(isLimitReached())showLimitOverlay();
  </script>
</body>
</html>
