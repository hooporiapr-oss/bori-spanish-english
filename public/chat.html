<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Hey Bori ‚Äî Chat</title>
  <link rel="icon" type="image/png" href="/icon-01F.png">
  <link rel="apple-touch-icon" href="/icon-01F.png">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--body:'Nunito',sans-serif;--bg:#FFFDF8;--white:#FFF;--dark:#1A1A1A;--text:#2A2A2A;--text-2:#5A5A5A;--text-3:#999;--border:#EDE8DF;--warm:#F8F4ED;--sun:#FF6B35;--sun-dark:#E55A25;--sun-light:rgba(255,107,53,0.1);--green:#2A9D6E;--red:#E74C3C}
html,body{height:100%;overflow:hidden}
body{font-family:var(--body);background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.app{display:flex;flex-direction:column;height:100dvh;max-width:700px;margin:0 auto}
.hdr{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--white);border-bottom:1px solid var(--border);flex-shrink:0}
.hdr-back{text-decoration:none;font-size:24px;color:var(--text-2);padding:2px 6px;border-radius:8px}
.hdr-av{width:52px;height:52px;flex-shrink:0;overflow:hidden;transition:transform .3s}
.hdr-av img{width:100%;height:100%;object-fit:contain}
.hdr-av.speaking{animation:av-speak .6s ease-in-out infinite alternate}
@keyframes av-speak{0%{transform:scale(1)}100%{transform:scale(1.08)}}
.hdr-info{flex:1}
.hdr-name{font-size:18px;font-weight:800;color:var(--dark)}.hdr-name .hey{color:var(--sun)}
.hdr-sub{font-size:12px;color:var(--text-3);font-weight:600}
.share-btn{width:38px;height:38px;border-radius:50%;background:var(--warm);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:17px;transition:all .2s;flex-shrink:0}
.share-btn:hover{background:var(--sun-light);border-color:var(--sun)}
.voice-toggle{display:flex;align-items:center;flex-shrink:0;position:relative}
.voice-toggle-btn{width:38px;height:38px;border-radius:50%;background:var(--warm);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:all .25s;-webkit-tap-highlight-color:transparent;position:relative}
.voice-toggle-btn:active{transform:scale(.92)}
.voice-toggle-btn.on{background:var(--sun);border-color:var(--sun);box-shadow:0 0 16px rgba(255,107,53,0.35)}
.voice-toggle-btn.on .voice-icon-off{display:none}
.voice-toggle-btn.on .voice-icon-on{display:block}
.voice-toggle-btn:not(.on) .voice-icon-off{display:block}
.voice-toggle-btn:not(.on) .voice-icon-on{display:none}
.voice-icon-on{color:var(--white);font-size:18px;line-height:1}
.voice-icon-off{color:var(--text-3);font-size:18px;line-height:1}
.voice-toggle-btn.locked{opacity:.55;cursor:pointer}
.voice-lock-badge{position:absolute;bottom:-1px;right:-1px;width:16px;height:16px;background:var(--dark);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;border:1.5px solid var(--white)}
.voice-upgrade-tip{position:absolute;top:calc(100% + 8px);right:0;background:var(--dark);color:var(--white);padding:10px 14px;border-radius:14px;font-size:12px;font-weight:700;white-space:nowrap;opacity:0;pointer-events:none;transform:translateY(-4px);transition:all .2s;z-index:50;box-shadow:0 4px 16px rgba(0,0,0,0.2)}
.voice-upgrade-tip::before{content:'';position:absolute;top:-5px;right:14px;width:10px;height:10px;background:var(--dark);transform:rotate(45deg);border-radius:2px}
.voice-upgrade-tip.show{opacity:1;pointer-events:auto;transform:translateY(0)}
.voice-upgrade-tip a{color:var(--sun);text-decoration:none;font-weight:800}
.burger{width:38px;height:38px;border-radius:50%;background:var(--warm);border:1px solid var(--border);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;-webkit-tap-highlight-color:transparent}
.burger:active{transform:scale(.95)}
.burger-line{width:16px;height:2.5px;background:var(--sun);border-radius:2px;transition:all .3s}
.burger.open .burger-line:nth-child(1){transform:rotate(45deg) translate(4px,4px)}
.burger.open .burger-line:nth-child(2){opacity:0}
.burger.open .burger-line:nth-child(3){transform:rotate(-45deg) translate(4px,-4px)}
.menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:100;opacity:0;pointer-events:none;transition:opacity .3s}
.menu-overlay.open{opacity:1;pointer-events:auto}
.menu{position:fixed;top:0;right:-280px;width:280px;height:100%;background:var(--white);z-index:101;transition:right .3s cubic-bezier(.22,1,.36,1);box-shadow:-4px 0 24px rgba(0,0,0,0.1);display:flex;flex-direction:column;padding:28px 0;overflow-y:auto}
.menu.open{right:0}
.menu-header{padding:0 24px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.menu-header img{width:40px;height:40px;object-fit:contain}
.menu-header-text{flex:1}
.menu-header-title{font-size:18px;font-weight:900;color:var(--dark)}.menu-header-title .hey{color:var(--sun)}
.menu-header-sub{font-size:11px;color:var(--text-3);font-weight:600}
.menu-section{padding:18px 24px 8px;font-size:10px;font-weight:800;color:var(--text-3);text-transform:uppercase;letter-spacing:1.5px}
.menu-link{display:flex;align-items:center;gap:14px;padding:14px 24px;text-decoration:none;color:var(--text);font-size:16px;font-weight:700;transition:background .15s;-webkit-tap-highlight-color:transparent}
.menu-link:active{background:var(--warm)}
.menu-link-icon{font-size:22px;width:30px;text-align:center}
.menu-link-arrow{color:var(--text-3);font-size:14px;margin-left:auto}
.menu-spacer{flex:1}
.menu-footer{padding:16px 24px;border-top:1px solid var(--border)}
.menu-footer a{font-size:12px;color:var(--text-3);text-decoration:none;font-weight:600;margin-right:14px}
.menu-footer a:active{color:var(--sun)}
.menu-footer p{font-size:10px;color:var(--text-3);margin-top:8px;opacity:.5}
.toggle-bar{display:flex;align-items:center;justify-content:center;gap:10px;padding:8px 16px;background:var(--white);border-bottom:1px solid var(--border);flex-shrink:0}
.lang-label{font-size:10px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px}
.lang-toggle{display:flex;border-radius:50px;overflow:hidden;border:2px solid var(--border);background:var(--bg)}
.lang-btn{padding:5px 14px;font-size:13px;font-weight:800;border:none;cursor:pointer;background:transparent;color:var(--text-3);transition:all .2s;font-family:var(--body)}
.lang-btn.active{background:var(--sun);color:var(--white)}
.chat{flex:1;overflow-y:auto;padding:16px 14px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;padding:20px 16px;gap:14px}
.w-av{width:220px;height:220px}.w-av img{width:100%;height:100%;object-fit:contain}
.w-desc{font-size:20px;color:var(--dark);max-width:340px;line-height:1.5;font-weight:900}
.row{display:flex;gap:8px;align-items:flex-start;max-width:92%}
.row-bori{align-self:flex-start}.row-user{align-self:flex-end;flex-direction:row-reverse}
.av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;margin-top:2px}
.av-bori{background:transparent;overflow:hidden}.av-user{background:var(--green);color:var(--white)}
.av-bori img{width:100%;height:100%;object-fit:contain}
.bub{padding:12px 16px;border-radius:20px;font-size:17px;line-height:1.6;word-wrap:break-word;white-space:pre-wrap}
.bub-bori{background:var(--warm);color:var(--text);border-bottom-left-radius:6px;position:relative}
.bub-user{background:var(--sun);color:var(--white);border-bottom-right-radius:6px;font-weight:600}
.bub-err{background:#FFF0F0;color:#C0392B;border-bottom-left-radius:6px}
.replay-btn{position:absolute;bottom:6px;right:8px;width:26px;height:26px;border-radius:50%;background:rgba(0,0,0,0.06);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;opacity:.5;transition:all .2s;-webkit-tap-highlight-color:transparent;padding:0}
.replay-btn:hover{opacity:.9;background:rgba(0,0,0,0.1)}
.dots{display:flex;gap:8px;align-items:flex-start;align-self:flex-start}
.dots .av{width:32px;height:32px;background:transparent;overflow:hidden}
.dots .av img{width:100%;height:100%;object-fit:contain}
.dots-bub{padding:14px 20px;border-radius:20px;background:var(--warm);border-bottom-left-radius:6px;display:flex;gap:6px;align-items:center}
.dot{width:8px;height:8px;border-radius:50%;background:var(--text-3);animation:dp 1.2s infinite}
.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
@keyframes dp{0%,100%{opacity:.3;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
.counter-bar{text-align:center;padding:6px 16px;font-size:12px;font-weight:700;color:var(--text-3);background:var(--bg);border-top:1px solid var(--border);flex-shrink:0}
.counter-bar .count{color:var(--sun);font-weight:900}
.counter-bar.low .count{color:var(--red)}
.input-bar{display:flex;align-items:flex-end;gap:8px;padding:10px 14px 14px;background:var(--white);border-top:1px solid var(--border);flex-shrink:0}
.input-bar textarea{flex:1;border:1.5px solid var(--border);border-radius:24px;padding:12px 18px;font-size:17px;font-family:var(--body);resize:none;outline:none;max-height:110px;line-height:1.4;color:var(--text);background:var(--bg);transition:border .2s}
.input-bar textarea::placeholder{color:var(--text-3)}
.input-bar textarea:focus{border-color:var(--sun)}
.input-bar.disabled textarea{opacity:.4;pointer-events:none}
.input-bar.disabled .send-btn{opacity:.2;pointer-events:none}
.input-bar.disabled .mic-btn{opacity:.2;pointer-events:none}
.send-btn{width:48px;height:48px;border-radius:50%;background:var(--sun);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
.send-btn:hover:not(:disabled){background:var(--sun-dark);transform:scale(1.05)}
.send-btn:disabled{opacity:.4;cursor:default}
.send-btn svg{width:22px;height:22px;fill:var(--white)}
.mic-btn{width:48px;height:48px;border-radius:50%;background:var(--warm);border:2px solid var(--border);cursor:pointer;display:none;align-items:center;justify-content:center;transition:all .25s;flex-shrink:0;-webkit-tap-highlight-color:transparent}
.mic-btn.visible{display:flex}
.mic-btn:hover{border-color:var(--sun);background:var(--sun-light)}
.mic-btn svg{width:22px;height:22px;fill:var(--text-2);transition:fill .2s}
.mic-btn.recording{background:var(--sun);border-color:var(--sun);animation:mic-pulse 1.5s ease-in-out infinite}
.mic-btn.recording svg{fill:var(--white)}
@keyframes mic-pulse{0%,100%{box-shadow:0 0 0 0 rgba(255,107,53,0.4)}50%{box-shadow:0 0 0 12px rgba(255,107,53,0)}}
.limit-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.limit-overlay.show{display:flex}
.limit-card{background:var(--white);border-radius:24px;padding:40px 28px;max-width:380px;width:92%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.15)}
.limit-icon{font-size:52px;margin-bottom:16px}
.limit-card h2{font-size:21px;font-weight:800;color:var(--dark);margin-bottom:8px}
.limit-card p{font-size:15px;color:var(--text-2);line-height:1.6;margin-bottom:20px}
.limit-timer{font-size:32px;font-weight:900;color:var(--sun);margin-bottom:20px;letter-spacing:2px}
.limit-share{display:inline-block;padding:14px 34px;border-radius:50px;background:var(--sun);color:var(--white);font-size:16px;font-weight:800;cursor:pointer;border:none;font-family:var(--body);transition:all .2s;margin-bottom:10px}
.limit-share:hover{background:var(--sun-dark)}
.limit-close{display:inline-block;padding:10px 24px;font-size:14px;color:var(--text-3);cursor:pointer;font-weight:700;background:none;border:none;font-family:var(--body)}
.limit-close:hover{color:var(--dark)}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--dark);color:var(--white);padding:12px 28px;border-radius:50px;font-size:14px;font-weight:700;opacity:0;transition:all .3s;z-index:300;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
@supports(padding-bottom:env(safe-area-inset-bottom)){.input-bar{padding-bottom:calc(14px + env(safe-area-inset-bottom))}}
  </style>
</head>
<body>
  <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
  <div class="menu" id="menu">
    <div class="menu-header"><img src="/icon.png" alt="Hey Bori"><div class="menu-header-text"><div class="menu-header-title"><span class="hey">Hey</span> Bori</div><div class="menu-header-sub" data-en="Your Digital Assistant" data-es="Tu Asistente Digital">Your Digital Assistant</div></div></div>
    <div class="menu-section" data-en="MAIN" data-es="PRINCIPAL">MAIN</div>
    <a href="/" class="menu-link"><span class="menu-link-icon">üè†</span>Home<span class="menu-link-arrow">‚Ä∫</span></a>
    <a href="/chat" class="menu-link"><span class="menu-link-icon">üí¨</span>Chat<span class="menu-link-arrow">‚Ä∫</span></a>
    <div class="menu-section" data-en="CULTURAL GAMES" data-es="JUEGOS CULTURALES">CULTURAL GAMES</div>
    <a href="/the-conga.html" class="menu-link"><span class="menu-link-icon">ü•Å</span>Conga<span class="menu-link-arrow">‚Ä∫</span></a>
    <a href="/the-lelolai.html" class="menu-link"><span class="menu-link-icon">üî§</span>LeLoLai Letras<span class="menu-link-arrow">‚Ä∫</span></a>
    <a href="/the-domino.html" class="menu-link"><span class="menu-link-icon">üé≤</span>La Marquesina<span class="menu-link-arrow">‚Ä∫</span></a>
    <a href="/the-isla.html" class="menu-link"><span class="menu-link-icon">üß©</span>La Isla<span class="menu-link-arrow">‚Ä∫</span></a>
    <div class="menu-spacer"></div>
    <div class="menu-footer"><a href="/privacy.html">Privacy</a><a href="/terms.html">Terms</a><p>¬© 2026 GoStar Digital LLC üáµüá∑</p></div>
  </div>
  <div class="app">
    <div class="hdr">
      <a href="/" class="hdr-back">‚Üê</a>
      <div class="hdr-av" id="hdrAv"><img src="/icon.png" alt="Hey Bori"></div>
      <div class="hdr-info"><div class="hdr-name"><span class="hey">Hey</span> Bori</div><div class="hdr-sub" data-en="Your Digital Assistant" data-es="Tu Asistente Digital">Your Digital Assistant</div></div>
      <div class="voice-toggle" id="voiceToggle"><button class="voice-toggle-btn" id="voiceBtn" onclick="toggleVoice()"><span class="voice-icon-off">üîá</span><span class="voice-icon-on">üîä</span></button><div class="voice-upgrade-tip" id="voiceUpgradeTip">üîí Voice is a <a href="/">Bori Plus</a> feature</div></div>
      <button class="share-btn" onclick="doShare()">üì§</button>
      <button class="burger" id="burger" onclick="toggleMenu()"><div class="burger-line"></div><div class="burger-line"></div><div class="burger-line"></div></button>
    </div>
    <div class="toggle-bar"><span class="lang-label" data-en="Pick Your Language" data-es="Escoge Tu Idioma">Pick Your Language</span><div class="lang-toggle"><button class="lang-btn active" id="btn-en" onclick="setLang('en')">English</button><button class="lang-btn" id="btn-es" onclick="setLang('es')">Espa√±ol</button></div></div>
    <div class="chat" id="chat"><div class="welcome" id="welcome"><div class="w-av"><img src="/icon.png" alt="Hey Bori"></div><div class="w-desc" data-en="Hey Bori. Your Private Bilingual Spanish and English Digital Assistant." data-es="Hey Bori. Tu Asistente Digital Privado Biling√ºe de Espa√±ol e Ingl√©s.">Hey Bori. Your Private Bilingual Spanish and English Digital Assistant.</div></div></div>
    <div class="counter-bar" id="counterBar"><span id="counterText"><span class="count">0</span> / 10 messages today</span></div>
    <div class="input-bar" id="inputBar">
      <textarea id="inp" rows="1" placeholder="Type a message..." data-en="Type a message..." data-es="Escribe un mensaje..."></textarea>
      <button class="mic-btn" id="micBtn" onclick="toggleMic()"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button>
      <button class="send-btn" id="sendBtn" onclick="doSend()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
    </div>
  </div>
  <div class="limit-overlay" id="limitOverlay"><div class="limit-card"><div class="limit-icon">üáµüá∑</div><h2 data-en="Great conversations today!" data-es="¬°Buenas conversaciones hoy!">Great conversations today!</h2><p data-en="You've used all 10 free messages for today. Hey Bori resets at midnight ‚Äî come back tomorrow to keep learning!" data-es="Usaste tus 10 mensajes gratis de hoy. Hey Bori se reinicia a medianoche ‚Äî ¬°vuelve ma√±ana pa' seguir aprendiendo!">You've used all 10 free messages for today. Hey Bori resets at midnight ‚Äî come back tomorrow to keep learning!</p><div class="limit-timer" id="limitTimer">--:--:--</div><button class="limit-share" onclick="doShare()" data-en="Share Hey Bori with a friend" data-es="Comparte Hey Bori con alguien">Share Hey Bori with a friend</button><br><button class="limit-close" onclick="closeLimitOverlay()" data-en="Close" data-es="Cerrar">Close</button></div></div>
  <div class="toast" id="toast"></div>
  <script>
var chat=document.getElementById('chat'),inp=document.getElementById('inp'),sendBtn=document.getElementById('sendBtn');
var counterBar=document.getElementById('counterBar'),inputBar=document.getElementById('inputBar');
var limitOverlay=document.getElementById('limitOverlay');
var micBtn=document.getElementById('micBtn'),voiceBtn=document.getElementById('voiceBtn');
var voiceUpgradeTip=document.getElementById('voiceUpgradeTip'),hdrAv=document.getElementById('hdrAv');
var hist=[],busy=false,lang='en',MAX_MSGS=10,isSubscriber=false;
var voiceOn=false,isRecording=false,mediaRecorder=null,audioChunks=[],currentAudio=null,upgradeTipTimer=null;

function toggleVoice(){if(!isSubscriber){showUpgradeTip();return;}voiceOn=!voiceOn;voiceBtn.classList.toggle('on',voiceOn);updateReplayButtons();try{localStorage.setItem('bori-voice',voiceOn?'1':'0');}catch(e){}if(voiceOn){showToast(lang==='es'?'üîä Voz autom√°tica activada':'üîä Auto-voice on');}else{showToast(lang==='es'?'üîá Voz autom√°tica desactivada':'üîá Auto-voice off');stopAudio();if(isRecording)stopRecording();}}
function showUpgradeTip(){if(upgradeTipTimer)clearTimeout(upgradeTipTimer);voiceUpgradeTip.classList.add('show');upgradeTipTimer=setTimeout(function(){voiceUpgradeTip.classList.remove('show');},3500);}
document.addEventListener('click',function(e){if(!e.target.closest('.voice-toggle'))voiceUpgradeTip.classList.remove('show');});

function speakText(text){if(!voiceOn)return;stopAudio();hdrAv.classList.add('speaking');fetch('/api/voice/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:text,lang:lang})}).then(function(r){if(!r.ok)throw new Error('TTS failed');return r.blob();}).then(function(blob){var url=URL.createObjectURL(blob);currentAudio=new Audio(url);currentAudio.onended=function(){hdrAv.classList.remove('speaking');URL.revokeObjectURL(url);currentAudio=null;};currentAudio.onerror=function(){hdrAv.classList.remove('speaking');currentAudio=null;};currentAudio.play().catch(function(){hdrAv.classList.remove('speaking');});}).catch(function(err){console.error('TTS error:',err);hdrAv.classList.remove('speaking');});}
function stopAudio(){if(currentAudio){currentAudio.pause();currentAudio.currentTime=0;currentAudio=null;}hdrAv.classList.remove('speaking');}

function toggleMic(){if(!isSubscriber){showUpgradeTip();return;}if(isLimitReached()){showLimitOverlay();return;}if(busy)return;if(isRecording){stopRecording();return;}stopAudio();startRecording();}
function startRecording(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){showToast(lang==='es'?'Tu navegador no soporta grabaci√≥n':'Your browser doesn\'t support recording');return;}navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,sampleRate:16000}}).then(function(stream){audioChunks=[];var mimeType='';var typeTests=['audio/mp4','audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus'];for(var i=0;i<typeTests.length;i++){if(MediaRecorder.isTypeSupported(typeTests[i])){mimeType=typeTests[i];break;}}console.log('Recording format:',mimeType||'default');var opts=mimeType?{mimeType:mimeType}:{};mediaRecorder=new MediaRecorder(stream,opts);var recStartTime=Date.now();mediaRecorder.ondataavailable=function(e){if(e.data.size>0)audioChunks.push(e.data);};mediaRecorder.onstop=function(){stream.getTracks().forEach(function(t){t.stop();});var duration=Date.now()-recStartTime;if(duration<1500){showToast(lang==='es'?'Habla un poco m√°s largo':'Speak a bit longer');return;}if(audioChunks.length===0){showToast(lang==='es'?'No se grab√≥ audio':'No audio recorded');return;}var actualType=mediaRecorder.mimeType||mimeType||'audio/mp4';var blob=new Blob(audioChunks,{type:actualType});console.log('Audio blob:',actualType,'size:',blob.size,'duration:',duration+'ms');transcribeAudio(blob);};mediaRecorder.start(100);isRecording=true;micBtn.classList.add('recording');inp.placeholder=lang==='es'?'Escuchando...':'Listening...';setTimeout(function(){if(isRecording)stopRecording();},30000);}).catch(function(err){console.error('Mic error:',err);if(err.name==='NotAllowedError'){showToast(lang==='es'?'Permite el micr√≥fono en ajustes':'Allow microphone in settings');}else{showToast(lang==='es'?'Error de micr√≥fono':'Microphone error');}});}
function stopRecording(){if(mediaRecorder&&mediaRecorder.state==='recording')mediaRecorder.stop();isRecording=false;micBtn.classList.remove('recording');inp.placeholder=lang==='es'?'Escribe un mensaje...':'Type a message...';}
function transcribeAudio(blob){inp.placeholder=lang==='es'?'Transcribiendo...':'Transcribing...';fetch('/api/voice/stt',{method:'POST',headers:{'Content-Type':blob.type||'audio/webm','X-Lang':lang},body:blob}).then(function(r){return r.json();}).then(function(data){inp.placeholder=lang==='es'?'Escribe un mensaje...':'Type a message...';if(data.text&&data.text.trim()){inp.value=data.text.trim();inp.style.height='auto';inp.style.height=Math.min(inp.scrollHeight,110)+'px';setTimeout(function(){doSend();},200);}else{showToast(lang==='es'?'No entend√≠ ‚Äî intenta de nuevo':'Didn\'t catch that ‚Äî try again');}}).catch(function(){inp.placeholder=lang==='es'?'Escribe un mensaje...':'Type a message...';showToast(lang==='es'?'Error de transcripci√≥n':'Transcription error');});}

function addReplayBtn(el,text){var btn=document.createElement('button');btn.className='replay-btn';btn.innerHTML='üîä';btn.onclick=function(e){e.stopPropagation();playTTS(text);};el.appendChild(btn);}
function updateReplayButtons(){}
function playTTS(text){stopAudio();hdrAv.classList.add('speaking');fetch('/api/voice/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:text,lang:lang})}).then(function(r){if(!r.ok)throw new Error('TTS failed');return r.blob();}).then(function(blob){var url=URL.createObjectURL(blob);currentAudio=new Audio(url);currentAudio.onended=function(){hdrAv.classList.remove('speaking');URL.revokeObjectURL(url);currentAudio=null;};currentAudio.onerror=function(){hdrAv.classList.remove('speaking');currentAudio=null;};currentAudio.play().catch(function(){hdrAv.classList.remove('speaking');});}).catch(function(err){console.error('TTS error:',err);hdrAv.classList.remove('speaking');});}
function updateVoiceLock(){if(isSubscriber){var b=voiceBtn.querySelector('.voice-lock-badge');if(b)b.remove();voiceBtn.classList.remove('locked');}else{if(!voiceBtn.querySelector('.voice-lock-badge')){var b=document.createElement('span');b.className='voice-lock-badge';b.textContent='üîí';voiceBtn.appendChild(b);}voiceBtn.classList.add('locked');}}
function restoreVoicePref(){if(!isSubscriber)return;micBtn.classList.add('visible');try{if(localStorage.getItem('bori-voice')==='1'){voiceOn=true;voiceBtn.classList.add('on');}}catch(e){}}

function checkSubscription(){try{var email=localStorage.getItem('bori-email');if(!email){updateVoiceLock();return;}fetch('/api/stripe/status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:email})}).then(function(r){return r.json()}).then(function(data){if(data.subscribed){isSubscriber=true;MAX_MSGS=999999;counterBar.style.display='none';if(limitOverlay.classList.contains('show'))closeLimitOverlay();inputBar.className='input-bar';inp.placeholder=lang==='es'?'Escribe un mensaje...':'Type a message...';}updateVoiceLock();restoreVoicePref();}).catch(function(){updateVoiceLock();});}catch(e){updateVoiceLock();}}
(function(){var p=new URLSearchParams(window.location.search);if(p.get('upgraded')==='true'){var email=prompt(lang==='es'?'¬°Bienvenido a Bori Plus! Ingresa tu email para activar:':'Welcome to Bori Plus! Enter your email to activate:');if(email){localStorage.setItem('bori-email',email);window.history.replaceState({},'','/chat');checkSubscription();}}else{checkSubscription();}})();

function toggleMenu(){document.getElementById('burger').classList.toggle('open');document.getElementById('menu').classList.toggle('open');document.getElementById('menuOverlay').classList.toggle('open');}
function getTodayKey(){var d=new Date();return 'bori-msgs-'+d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();}
function getMsgCount(){try{var v=localStorage.getItem(getTodayKey());return v?parseInt(v,10):0;}catch(e){return 0;}}
function incMsgCount(){try{var key=getTodayKey(),count=getMsgCount()+1;localStorage.setItem(key,count.toString());for(var i=localStorage.length-1;i>=0;i--){var k=localStorage.key(i);if(k&&k.startsWith('bori-msgs-')&&k!==key)localStorage.removeItem(k);}return count;}catch(e){return 0;}}
function isLimitReached(){return getMsgCount()>=MAX_MSGS;}
function updateCounter(){var count=getMsgCount(),rem=MAX_MSGS-count;document.getElementById('counterText').innerHTML=lang==='es'?'<span class="count">'+count+'</span> / '+MAX_MSGS+' mensajes hoy':'<span class="count">'+count+'</span> / '+MAX_MSGS+' messages today';counterBar.className=rem<=2&&rem>0?'counter-bar low':'counter-bar';if(isLimitReached()){inputBar.className='input-bar disabled';inp.placeholder=lang==='es'?'L√≠mite diario alcanzado':'Daily limit reached';}else{inputBar.className='input-bar';inp.placeholder=lang==='es'?'Escribe un mensaje...':'Type a message...';}}
function getTimeToMidnight(){var now=new Date(),mn=new Date(now);mn.setHours(24,0,0,0);var d=mn-now;var h=Math.floor(d/3600000),m=Math.floor((d%3600000)/60000),s=Math.floor((d%60000)/1000);return(h<10?'0':'')+h+':'+(m<10?'0':'')+m+':'+(s<10?'0':'')+s;}
setInterval(function(){document.getElementById('limitTimer').textContent=getTimeToMidnight();if(!isLimitReached()&&limitOverlay.classList.contains('show')){closeLimitOverlay();updateCounter();}},1000);
function showLimitOverlay(){limitOverlay.className='limit-overlay show';}
function closeLimitOverlay(){limitOverlay.className='limit-overlay';}
function doShare(){var url=window.location.origin;var t=lang==='es'?'Estoy aprendiendo espa√±ol e ingl√©s con Hey Bori ‚Äî ¬°pru√©balo! üáµüá∑ '+url:'I\'m learning Spanish & English with Hey Bori ‚Äî try it! üáµüá∑ '+url;if(navigator.share){navigator.share({title:'Hey Bori',text:t,url:url}).catch(function(){});}else{navigator.clipboard.writeText(t).then(function(){showToast(lang==='es'?'¬°Enlace copiado!':'Link copied!');}).catch(function(){});}}
function showToast(msg){var t=document.getElementById('toast');t.textContent=msg;t.className='toast show';setTimeout(function(){t.className='toast';},2500);}
function setLang(l){lang=l;document.getElementById('btn-en').className='lang-btn'+(l==='en'?' active':'');document.getElementById('btn-es').className='lang-btn'+(l==='es'?' active':'');var els=document.querySelectorAll('[data-'+l+']');for(var i=0;i<els.length;i++){var el=els[i],val=el.getAttribute('data-'+l);if(val&&el.tagName==='TEXTAREA')el.placeholder=val;else if(val&&!el.classList.contains('lang-btn'))el.textContent=val;}updateCounter();}
inp.addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,110)+'px';});
inp.addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();doSend();}});
function clearWelcome(){var w=document.getElementById('welcome');if(w)w.remove();}
function addBub(who,text,isErr){clearWelcome();var r=document.createElement('div');r.className='row row-'+who;var a=document.createElement('div');a.className='av av-'+who;if(who==='bori')a.innerHTML='<img src="/icon.png" alt="Bori">';else a.textContent='üë§';var b=document.createElement('div');b.className=isErr?'bub bub-err':'bub bub-'+who;b.textContent=text;r.appendChild(a);r.appendChild(b);chat.appendChild(r);chat.scrollTop=chat.scrollHeight;if(who==='bori'&&!isErr)addReplayBtn(b,text);}
function addDots(){var d=document.createElement('div');d.className='dots';d.id='dots';d.innerHTML='<div class="av"><img src="/icon.png" alt="Bori"></div><div class="dots-bub"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}
function killDots(){var d=document.getElementById('dots');if(d)d.remove();}

window.doSend=async function(){var text=inp.value.trim();if(!text||busy)return;if(isLimitReached()){showLimitOverlay();return;}busy=true;sendBtn.disabled=true;inp.value='';inp.style.height='auto';addBub('user',text);hist.push({role:'user',content:text});incMsgCount();updateCounter();addDots();stopAudio();
try{var ctrl=new AbortController();var tmout=setTimeout(function(){ctrl.abort();},45000);var res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,history:hist.slice(-20),lang:lang}),signal:ctrl.signal});clearTimeout(tmout);killDots();
if(!res.ok||!res.body){addBub('bori',lang==='es'?'Se fue el tiempo. Intenta de nuevo.':'Had a timeout. Try again.',true);busy=false;sendBtn.disabled=false;return;}
clearWelcome();var r=document.createElement('div');r.className='row row-bori';var a=document.createElement('div');a.className='av av-bori';a.innerHTML='<img src="/icon.png" alt="Bori">';var b=document.createElement('div');b.className='bub bub-bori';b.textContent='';r.appendChild(a);r.appendChild(b);chat.appendChild(r);
var fullReply='',reader=res.body.getReader(),decoder=new TextDecoder(),buffer='';
while(true){var result=await reader.read();if(result.done)break;buffer+=decoder.decode(result.value,{stream:true});var lines=buffer.split('\n');buffer=lines.pop()||'';for(var i=0;i<lines.length;i++){var line=lines[i].trim();if(!line.startsWith('data: '))continue;try{var evt=JSON.parse(line.slice(6));if(evt.type==='text'){fullReply+=evt.text;b.textContent=fullReply;chat.scrollTop=chat.scrollHeight;}else if(evt.type==='error'&&!fullReply){b.className='bub bub-err';b.textContent=evt.error||'Something went wrong.';}}catch(pe){}}}
if(!fullReply){b.className='bub bub-err';b.textContent=lang==='es'?'No recib√≠ respuesta. Intenta de nuevo.':'No response received. Try again.';}
if(fullReply){addReplayBtn(b,fullReply);if(voiceOn)playTTS(fullReply);}
hist.push({role:'assistant',content:fullReply});if(hist.length>40)hist=hist.slice(-40);if(isLimitReached())setTimeout(function(){showLimitOverlay();},1500);
}catch(e){killDots();addBub('bori',e.name==='AbortError'?(lang==='es'?'Se agot√≥ el tiempo. Intenta de nuevo.':'Request timed out. Try again.'):(lang==='es'?'Problema de conexi√≥n. Intenta de nuevo.':'Connection issue. Try again.'),true);}
busy=false;sendBtn.disabled=false;inp.focus();};
updateCounter();updateVoiceLock();if(isLimitReached())showLimitOverlay();
  </script>
</body>
</html>
